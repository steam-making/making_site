{% extends "base.html" %}
{% load form_tags %}

{% block content %}
<div class="container mt-5" style="max-width: 720px;">
  <div class="card shadow rounded-4 border-0">
    <div class="card-body p-5">
      <h3 class="text-center mb-4 fw-bold">{{ title|default:"ì¶œê°• ë“±ë¡" }}</h3>

      <form method="post">
        {% csrf_token %}

        {% if user.is_staff %}
        <!-- ê°•ì‚¬ ì„ íƒ -->
        <div class="mb-4">
          <label for="id_teacher_choice" class="form-label">ê°•ì‚¬ ì„ íƒ</label>
          {{ form.teacher_choice|add_class:"form-select" }}
        </div>
        {% endif %}

        <!-- ì¶œê°• ì¥ì†Œ ìœ í˜• -->
        <div class="mb-4">
          <label class="form-label">ì¶œê°• ì¥ì†Œ ìœ í˜•</label>
          <div class="d-flex gap-3 flex-wrap">
            {% for radio in form.place_type %}
              <div class="form-check">
                {{ radio.tag }}
                <label class="form-check-label ms-1">
                  {{ radio.choice_label }}
                </label>
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- ================= í•™êµ ê²€ìƒ‰ ================= -->
        <div id="school-box" class="mb-4 position-relative">
          <label class="form-label">í•™êµ ì„ íƒ (ê²€ìƒ‰)</label>

          <input type="text"
                 id="school_search"
                 class="form-control"
                 placeholder="í•™êµëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                 autocomplete="off">

          <div id="school_result"
               class="list-group position-absolute w-100"
               style="z-index:2000; max-height:200px; overflow-y:auto;"></div>

          <!-- ì‹¤ì œ ì €ì¥ë˜ëŠ” FK -->
          <input type="hidden" name="school" id="school_id">

          <div class="form-text">í•™êµë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.</div>

          <!-- ğŸ« í•™êµ ì£¼ì†Œ í‘œì‹œ -->
          <div id="school-address-box" class="mt-2" style="display:none;">
            <div class="alert alert-light border py-2 px-3 mb-0">
              <i class="bi bi-geo-alt-fill me-1 text-danger"></i>
              <span id="school-address-text"></span>
            </div>
          </div>
        </div>

        <!-- ================= ê¸°ê´€ëª… ì…ë ¥ ================= -->
        <div id="name-box" class="mb-4">
          <label for="id_name" class="form-label">ê¸°ê´€ëª…</label>
          {{ form.name|add_class:"form-control" }}
        </div>

        <!-- í”„ë¡œê·¸ë¨ -->
        <div class="mb-4">
          <label for="id_program" class="form-label">í”„ë¡œê·¸ë¨ëª…</label>
          {{ form.program|add_class:"form-control" }}
        </div>

        <!-- ë‹´ë‹¹ì ì´ë©”ì¼ -->
        <div class="mb-4">
          <label for="id_contact_email" class="form-label">ë‹´ë‹¹ì ì´ë©”ì¼</label>
          {{ form.contact_email|add_class:"form-control" }}
        </div>

        <!-- í–‰ì •ì‹¤ ì´ë©”ì¼ -->
        <div class="mb-4">
          <label for="id_admin_email" class="form-label">í–‰ì •ì‹¤ ì´ë©”ì¼</label>
          {{ form.admin_email|add_class:"form-control" }}
        </div>

        <!-- ì¶œê°• ìš”ì¼ -->
        <div class="mb-4">
          <label class="form-label d-block mb-2">ì¶œê°• ìš”ì¼</label>
          <div class="d-flex flex-wrap gap-2">
            {% for checkbox in form.days %}
              <div class="form-check me-3">
                {{ checkbox.tag }}
                <label class="form-check-label ms-1">
                  {{ checkbox.choice_label }}
                </label>
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="text-end mt-4">
          <button type="submit" class="btn btn-primary me-2">
            {{ submit_label|default:"ë“±ë¡í•˜ê¸°" }}
          </button>
          <a href="{% url 'institution_list' %}" class="btn btn-outline-secondary">
            ëª©ë¡ìœ¼ë¡œ
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ================= JS ================= -->
<script>
const schoolBox     = document.getElementById("school-box");
const nameBox       = document.getElementById("name-box");
const schoolInput   = document.getElementById("school_search");
const schoolResult  = document.getElementById("school_result");
const schoolHidden  = document.getElementById("school_id");
const nameInput     = document.getElementById("id_name");
const addressBox   = document.getElementById("school-address-box");
const addressText  = document.getElementById("school-address-text");

/* ì¶œê°• ì¥ì†Œ ìœ í˜•ì— ë”°ë¥¸ UI í† ê¸€ */
function togglePlaceType(type) {
    if (type === "school") {
        schoolBox.style.display = "block";
        nameBox.style.display   = "none";
        nameInput.value = "";
    } else {
        schoolBox.style.display = "none";
        nameBox.style.display   = "block";
        schoolHidden.value = "";
        schoolInput.value  = "";
        addressBox.style.display = "none";
    }
}

/* ì¥ì†Œ ìœ í˜• ë³€ê²½ ê°ì§€ */
document.querySelectorAll("input[name='place_type']").forEach(radio => {
    radio.addEventListener("change", function () {
        togglePlaceType(this.value);
    });
});

/* í•™êµ ê²€ìƒ‰ */
schoolInput.addEventListener("input", function () {
    const q = this.value.trim();
    if (q.length < 1) {
        schoolResult.innerHTML = "";
        return;
    }

    fetch(`/schools/search/?q=` + encodeURIComponent(q))
        .then(res => res.json())
        .then(data => {
            let html = "";
            data.forEach(s => {
                html += `
                  <button type="button"
                    class="list-group-item list-group-item-action"
                    data-id="${s.id}"
                    data-name="${s.name}"
                    data-address="${s.address || ""}">
                    <strong>${s.name}</strong><br>
                    <small class="text-muted">${s.address || ""}</small>
                  </button>
                `;
            });
            schoolResult.innerHTML = html;
        });
});

/* í•™êµ í´ë¦­ */
schoolResult.addEventListener("click", function (e) {
    const btn = e.target.closest("button");
    if (!btn) return;

    const id      = btn.dataset.id;
    const name    = btn.dataset.name;
    const address = btn.dataset.address;

    schoolHidden.value = id;
    schoolInput.value  = name;
    nameInput.value    = name; // ê³¼ë„ê¸°ìš©

    if (address) {
        addressText.textContent = address;
        addressBox.style.display = "block";
    } else {
        addressBox.style.display = "none";
    }

    schoolResult.innerHTML = "";
});

/* ìˆ˜ì • í™”ë©´ ì§„ì… ì‹œ ì´ˆê¸° ë³µì› */
document.addEventListener("DOMContentLoaded", function () {
    const checked = document.querySelector("input[name='place_type']:checked");
    if (checked) {
        togglePlaceType(checked.value);
    }

    const schoolId = "{{ school_id|default:'' }}";

    if (schoolId) {
        fetch(`/schools/${schoolId}/detail/`)
            .then(res => res.json())
            .then(data => {
                schoolHidden.value = data.id;
                schoolInput.value  = data.name;

                if (data.address) {
                    addressText.textContent = data.address;
                    addressBox.style.display = "block";
                }
            });
    }
});
</script>
{% endblock %}
