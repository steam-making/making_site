<!-- === íŒŒì¼: templates/reservation/reservation_calendar.html === -->
{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <h3 class="text-center mb-3">
    <i class="bi bi-calendar-week"></i> ì˜ˆì•½ ë‹¬ë ¥
  </h3>
  <div class="card shadow-sm border-0 rounded-3 p-3">
    <div id="calendar"></div>
  </div>
</div>

<!-- âœ… ì˜ˆì•½ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-info-circle"></i> ì˜ˆì•½ ìƒì„¸</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><i class="bi bi-journal-code"></i> <strong id="eventTitle"></strong></p>
        <p><i class="bi bi-list-task"></i> ì£¼ì œ : <span id="eventTopic"></span></p> 
        <p><i class="bi bi-clock"></i> ì‹œê°„ : <span id="eventTime"></span></p>
        <p><i class="bi bi-people"></i> ì¸ì› : <span id="eventHeadcount"></span></p>
        <p><i class="bi bi-geo-alt"></i> ì¥ì†Œ : <span id="eventPlace"></span></p>
        <p><i class="bi bi-flag"></i> ìƒíƒœ : <span id="eventStatus"></span></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<link href="{% static 'css/reservation_calendar.css' %}" rel="stylesheet"> 
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'ko',
    height: "auto",
    dayMaxEventRows: true,
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,listMonth'
    },
    events: '{% url "reservation_events" %}',

    // âœ… 24ì‹œê°„ í˜•ì‹ (ì˜¤ì „/ì˜¤í›„ ì œê±°)
    eventTimeFormat: {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false  // â† 24ì‹œê°„ì œ
    },

    // âœ… ë·°ë³„ ê°œë³„ ì œëª© í¬ë§·
    views: {
      dayGridMonth: {
        titleFormat: { year: 'numeric', month: 'long' }   // 2025ë…„ 9ì›”
      },
      timeGridWeek: {
        titleFormat: { year: 'numeric', month: '2-digit', day: '2-digit' } // 2025.09.12
      },
      listMonth: {
        titleFormat: { year: 'numeric', month: 'long' } // 2025.09
      },
      timeGridDay: {
        titleFormat: { year: 'numeric', month: '2-digit', day: '2-digit' } // 2025.09.12
      }
    },

    datesSet: function(info) { 
      console.log("ğŸ“Œ datesSet ì‹¤í–‰ë¨:", info.view.type);

      if (info.view.type.includes("list")) {
        document.querySelectorAll('.fc-list-day').forEach(function(dayRow) {
          const cushion = dayRow.querySelector(".fc-list-day-cushion"); // âœ… td ì „ì²´
          const textEl = dayRow.querySelector(".fc-list-day-text");     // ë‚ ì§œ/ìš”ì¼ í…ìŠ¤íŠ¸
          if (!cushion || !textEl) return;

          const dateStr = dayRow.getAttribute("data-date"); // "2025-09-11"
          if (!dateStr) return;

          const dateObj = new Date(dateStr + "T00:00:00");
          const weekday = dateObj.getDay(); // 0=ì¼ ~ 6=í† 
          console.log("â¡ í—¤ë”:", textEl.innerText, "ìš”ì¼:", weekday);

          // âœ… ê³µí†µ cushion ìŠ¤íƒ€ì¼
          cushion.style.setProperty("font-weight", "700");
          cushion.style.setProperty("font-size", "1rem");
          cushion.style.setProperty("text-decoration", "none");
          cushion.style.setProperty("color", "#fff", "important");
          cushion.style.setProperty("text-align", "center");
          cushion.style.setProperty("padding", "8px");
          cushion.style.setProperty("border-radius", "6px");

          // ìš”ì¼ë³„ ë°°ê²½ìƒ‰ (ì…€ ì „ì²´ì— ì ìš©)
          switch (weekday) {
            case 0: // ì¼ìš”ì¼
              cushion.style.setProperty("background-color", "#e74c3c", "important");
              cushion.style.setProperty("color", "#fff", "important");
              break;
            case 1: // ì›”ìš”ì¼
              cushion.style.setProperty("background-color", "#f39c12", "important");
              cushion.style.setProperty("color", "#000", "important");
              break;
            case 2: // í™”ìš”ì¼
              cushion.style.setProperty("background-color", "#27ae60", "important");
              cushion.style.setProperty("color", "#fff", "important");
              break;
            case 3: // ìˆ˜ìš”ì¼
              cushion.style.setProperty("background-color", "#2980b9", "important");
              cushion.style.setProperty("color", "#fff", "important");
              break;
            case 4: // ëª©ìš”ì¼
              cushion.style.setProperty("background-color", "#8e44ad", "important");
              cushion.style.setProperty("color", "#fff", "important");
              break;
            case 5: // ê¸ˆìš”ì¼
              cushion.style.setProperty("background-color", "#16a085", "important");
              cushion.style.setProperty("color", "#fff", "important");
              break;
            case 6: // í† ìš”ì¼
              cushion.style.setProperty("background-color", "#2c3e50", "important");
              cushion.style.setProperty("color", "#fff", "important");
              break;
          }
        });
      }
    },



    eventContent: function(arg) {
      const props = arg.event.extendedProps;
      const start = arg.event.start;
      const end = arg.event.end;

      // ë‚ ì§œ (YYYY-MM-DD)
      const dateStr = start ? start.toLocaleDateString("ko-KR", {
        year: "numeric", month: "2-digit", day: "2-digit"
      }) : "";

      // ì‹œê°„ (24ì‹œê°„ í˜•ì‹)
      const startStr = start ? start.toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit", hour12: false }) : "";
      const endStr   = end   ? end.toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit", hour12: false }) : "";

      const prog   = arg.event.title || "";
      const inst   = props.institution || "";
      const status = props.status || "";
      const statusCode = props.status_code || "";
      const place  = props.place || "";

      // âœ… list ë·° â†’ í…Œì´ë¸” í•œ ì¤„ ìŠ¤íƒ€ì¼
      if (arg.view.type.startsWith("list")) {
        return {
          html: `
            <div class="fc-event-custom-row">
              <div class="col-status">
                <span class="status-dot status-${statusCode}"></span>
                ${status}
              </div>
              <div class="col-inst">${inst}</div>
              <div class="col-prog">${prog}</div>
              <div class="col-place">${place}</div>
            </div>
          `
        };
      }

      // âœ… ì›”/ì£¼/ì¼ ë·° â†’ ì‹œê°„ / ê¸°ê´€ëª… / í”„ë¡œê·¸ë¨ëª… (ì„¸ ì¤„)
      return {
        html: `
          <div class="fc-event-custom">
            <div class="fc-event-time"><strong>${startStr} ${inst}</strong></div>
            <div class="fc-event-program">${prog}</div>
          </div>
        `
      };
    },


    eventDidMount: function(info) {
      // âœ… ê¸°ë³¸ í°ìƒ‰ ë°°ê²½
      info.el.style.backgroundColor = "#fff";
      info.el.style.color = "#000"; // ê¸°ë³¸ ê¸€ì”¨ëŠ” ê²€ì •

      // ìƒíƒœë³„ í…Œë‘ë¦¬/ê¸€ì”¨ìƒ‰ ê°•ì¡°
      if (info.event.extendedProps.status === "ì˜ˆì•½í™•ì •") {
        info.el.style.borderLeft = "6px solid #28a745"; // ì´ˆë¡ í…Œë‘ë¦¬
        info.el.style.color = "#28a745";                // ê¸€ì”¨ ì´ˆë¡
      } else if (info.event.extendedProps.status === "ì˜ˆì•½ìš”ì²­") {
        info.el.style.borderLeft = "6px solid #ffc107"; // ë…¸ë‘ í…Œë‘ë¦¬
        info.el.style.color = "#e67e22";                // ê¸€ì”¨ ì£¼í™©
      } else if (info.event.extendedProps.status === "ì˜ˆì•½ì·¨ì†Œ") {
        info.el.style.borderLeft = "6px solid #dc3545"; // ë¹¨ê°• í…Œë‘ë¦¬
        info.el.style.color = "#dc3545";                // ê¸€ì”¨ ë¹¨ê°•
      }

      info.el.classList.add("fc-event-clean");
    },
    eventClick: function(info) {
      const props = info.event.extendedProps;
      document.getElementById("eventTitle").textContent = info.event.title;
      document.getElementById("eventTopic").textContent = props.topic || '-';
      document.getElementById("eventHeadcount").textContent = props.headcount || '-';
      document.getElementById("eventPlace").textContent = props.place || '-';
      document.getElementById("eventStatus").textContent = props.status || '-';
      document.getElementById("eventTime").textContent =
        info.event.startStr.slice(11,16) + " ~ " + (info.event.endStr ? info.event.endStr.slice(11,16) : "");
      new bootstrap.Modal(document.getElementById('eventDetailModal')).show();
    }
  });

  calendar.render();
});
</script>
<style></style>
{% endblock %}
