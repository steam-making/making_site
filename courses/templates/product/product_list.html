{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h3 class="mb-0">
      <i class="bi bi-box-seam"></i> 프로그램 목록
    </h3>
    <div class="d-flex gap-2">
      <!-- 카테고리 필터 -->
      <form method="get" class="d-flex">
        <select name="category" class="form-select form-select-sm me-2" onchange="this.form.submit()">
          <option value="">-- 전체 카테고리 --</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if selected_category and selected_category == c.id %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>
      </form>

      {% if user.is_staff or user.is_superuser %}
        <a href="{% url 'product_create' %}" class="btn btn-primary btn-sm">
          <i class="bi bi-plus-circle"></i> 새 프로그램 등록
        </a>
        <a href="{% url 'category_list' %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-tags"></i> 카테고리 관리
        </a>
      {% endif %}
    </div>
  </div>

  <!-- 카드 목록 -->
  <div class="row g-3">
    {% for p in products %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <div class="card h-100 shadow-sm border-0 rounded-3">

        <!-- 프로그램 이미지 -->
        {% if p.image %}
          <img src="{{ p.image.url }}" class="card-img-top" alt="{{ p.name }}" style="height:160px; object-fit:cover;">
        {% else %}
          <div class="bg-light d-flex align-items-center justify-content-center" style="height:160px;">
            <i class="bi bi-image text-muted" style="font-size:2rem;"></i>
          </div>
        {% endif %}

        <div class="card-body d-flex flex-column">
          <h6 class="card-title mb-1 fw-bold text-truncate">
            <i class="bi bi-journal-code me-1"></i> {{ p.name }}
            {% if user.is_staff %}
              {% if p.status == "private" %}
                <span class="badge bg-secondary">비공개</span>
              {% else %}
                <span class="badge bg-success">공개</span>
              {% endif %}
            {% endif %}
          </h6>

          <p class="text-muted small mb-2">
            <i class="bi bi-tags"></i> {{ p.category|default:"카테고리 없음" }}
          </p>

          <!-- 설명 -->
          <p class="card-text flex-grow-1 small text-secondary">
            {{ p.description|default:"설명 없음"|truncatechars:60 }}
          </p>

          <!-- 주제 태그 개수 표시 -->
          {% if p.topics %}
            {% if p.topics.0 == "자동주제선정" %}
              <div class="mb-2">
                <span class="badge"
                      style="background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
                            color: #333; font-weight:600; border-radius: 1rem; padding: 0.5em 0.9em;">
                  총 {{ p.topics|length|add:"-1" }}가지 주제
                </span>
              </div>
            {% else %}
              <div class="mb-2">
                <span class="badge"
                      style="background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
                            color: #333; font-weight:600; border-radius: 1rem; padding: 0.5em 0.9em;">
                  총 {{ p.topics|length }}가지 주제
                </span>
              </div>
            {% endif %}
          {% endif %}

          <!-- ✅ 가격/재료 표시 -->
          <div class="small mb-2">
            {% if p.include_material_cost %}
              <span class="text-success"><i class="bi bi-box-seam"></i> 재료비 포함</span>
            {% else %}
              <span class="text-danger"><i class="bi bi-tools"></i> 재료비 별도</span>
            {% endif %}
          </div>

          <!-- 가격 및 시간 + 버튼 -->
          <div class="d-flex justify-content-between align-items-center mt-2">
            <span class="fw-semibold text-primary small">
              <i class="bi bi-cash-coin"></i> {{ p.base_price|intcomma }}원 · 
              <i class="bi bi-clock-history"></i> {{ p.duration_minutes }}분
            </span>
            <div class="d-flex gap-1">
              <a href="{% url 'product_detail' p.id %}" class="btn btn-sm btn-outline-primary" title="상세보기">
                <i class="bi bi-eye"></i>
              </a>
              {% if user.is_staff or user.is_superuser %}
                <a href="{% url 'product_update' p.id %}" class="btn btn-sm btn-outline-secondary" title="수정">
                  <i class="bi bi-pencil-square"></i>
                </a>
                <form action="{% url 'product_delete' p.id %}" method="post" class="d-inline" onsubmit="return confirm('정말 삭제하시겠습니까?');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="삭제">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12 text-center text-muted py-5">
      <i class="bi bi-inbox"></i> 등록된 상품이 없습니다.
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
