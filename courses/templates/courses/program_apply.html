{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="container mt-4" style="max-width:720px;">
  <div class="card shadow-sm">
    <div class="card-body">
      <h4 class="mb-3 fw-bold"><i class="bi bi-pencil-square me-2"></i> ìˆ˜ê°•ì‹ ì²­ - {{ program.name }}</h4>
      
      <form method="post" class="vstack gap-3">
        {% csrf_token %}

        <!-- ğŸ”¥ í¼ ì—ëŸ¬ í‘œì‹œ -->
        {% if form.errors %}
          <div class="alert alert-danger">
            {% for field in form %}
              {% for error in field.errors %}
                <div>{{ field.label }}: {{ error }}</div>
              {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <div>{{ error }}</div>
            {% endfor %}
          </div>
        {% endif %}
        
        <div>
          <label class="form-label fw-bold"><i class="bi bi-book me-1"></i> í”„ë¡œê·¸ë¨</label>
          <input type="text" class="form-control" value="{{ program.name }}" disabled>
        </div>

        <div>
          <label class="form-label fw-bold"><i class="bi bi-people-fill me-1"></i> ëŒ€ìƒ</label>
          <input type="text" class="form-control" value="{{ program.get_target_range }}" disabled>
        </div>

        <div>
          <label class="form-label fw-bold"><i class="bi bi-people me-1"></i> ë°˜ ì„ íƒ</label>
          <select name="class_id" class="form-select" required>
            <option value="">-- ë°˜ì„ ì„ íƒí•˜ì„¸ìš” --</option>
            {% for cls in program.classes.all %}
              {% with applicants=cls.applications.count capacity=cls.capacity %}
                <option value="{{ cls.id }}" {% if applicants >= capacity %}disabled{% endif %}>
                  {{ cls.name }} ({{ applicants }} / {{ capacity }}ëª…)
                  {% if applicants >= capacity %} - ì •ì› ë§ˆê°{% endif %}
                </option>
              {% endwith %}
            {% endfor %}
          </select>
        </div>

        <!-- ì‹ ì²­ì ì •ë³´ (ìë™ ì…ë ¥) -->
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-bold"><i class="bi bi-person-fill me-1"></i> ì‹ ì²­ìëª…</label>
            <input type="text" class="form-control" value="{{ profile.user.first_name }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold"><i class="bi bi-telephone-fill me-1"></i> ì—°ë½ì²˜</label>
            <input type="text" class="form-control" value="{{ profile.phone_number }}" readonly>
          </div>
        </div>

        {% if profile.user_type == "parent" %}
        <!-- âœ… í•™ë¶€ëª¨ ì „ìš©: ìë…€ ì„ íƒ -->
        <div>
          <label class="form-label fw-bold"><i class="bi bi-people-fill me-1"></i> ìˆ˜ê°• ì‹ ì²­í•  ìë…€ ì„ íƒ</label>
          <div class="border rounded p-3">
            {% for child in children %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="children" value="{{ child.id }}" id="child{{ forloop.counter }}">
                <label class="form-check-label" for="child{{ forloop.counter }}">
                  {{ child.name }} ({{ child.birth_date|date:"Y.m.d" }})
                </label>
              </div>
            {% empty %}
              <p class="text-muted">ë“±ë¡ëœ ìë…€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë§ˆì´í˜ì´ì§€ì—ì„œ ìë…€ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</p>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- ìš”ì²­ì‚¬í•­ -->
        <div>
          <label class="form-label fw-bold"><i class="bi bi-chat-dots me-1"></i> ìš”ì²­ì‚¬í•­ (ì„ íƒ)</label>
          {{ form.memo }}
        </div>

        <div class="d-flex gap-2">
          <a href="{% url 'program_detail' program.id %}" class="btn btn-outline-secondary">ì·¨ì†Œ</a>
          <button class="btn btn-primary">ì‹ ì²­í•˜ê¸°</button>
        </div>
      </form>

      <p class="text-muted small mt-3">â€» ì‹ ì²­ í›„ ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ë©´ ì•ˆë‚´ê°€ ë°œì†¡ë©ë‹ˆë‹¤.</p>
    </div>
  </div>
</div>

<!-- âœ… ì•Œë¦¼ ëª¨ë‹¬ -->
    {% if messages %}
      {% for message in messages %}
      <div class="modal fade" id="alertModal{{ forloop.counter }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-{{ message.tags|default:'secondary' }}">
            <div class="modal-header bg-{{ message.tags|default:'secondary' }} text-white">
              <h5 class="modal-title">
                {% if message.tags == "success" %}âœ… ì„±ê³µ
                {% elif message.tags == "error" or message.tags == "danger" %}âŒ ì˜¤ë¥˜
                {% elif message.tags == "warning" %}âš ï¸ ì£¼ì˜
                {% else %}â„¹ï¸ ì•Œë¦¼{% endif %}
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              {{ message }}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">í™•ì¸</button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    {% endif %}

<style>
select.form-select option:disabled {
  color: #dc3545; /* ë¹¨ê°„ìƒ‰ */
  font-weight: bold;
}
</style>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const alertModal = document.querySelector('.modal[id^="alertModal"]');
  if (alertModal) {
    const modal = new bootstrap.Modal(alertModal);
    modal.show();
  }
});
</script>
{% endblock %}
