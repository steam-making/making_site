{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="container mt-4" style="max-width: 900px;">
  <div class="card shadow-sm border-0 rounded-3 overflow-hidden">
    <div class="row g-0">

      <!-- âœ… ì •ì‚¬ê°í˜• ì´ë¯¸ì§€ -->
      {% if program.image %}
      <div class="col-md-5">
        <div class="ratio ratio-1x1">
          <img src="{{ program.image.url }}" class="img-fluid object-fit-cover w-100 h-100" alt="{{ program.name }}">
        </div>
      </div>
      {% endif %}

      <div class="{% if program.image %}col-md-7{% else %}col-12{% endif %}">
        <div class="card-body d-flex flex-column">
          <h4 class="card-title fw-bold mb-2">
            {{ program.name }}
            <span class="badge
                  {% if program.status == 'open' and program.is_full %} bg-danger
                  {% elif program.status == 'open' %} bg-success
                  {% else %} bg-secondary {% endif %}">
              {{ program.display_status }}
            </span>
          </h4>

          {% if program.recruit_start_date and program.recruit_end_date %}
            <div class="text-muted small mb-3">
              <i class="bi bi-calendar-range me-1"></i> ëª¨ì§‘ê¸°ê°„:
              {{ program.recruit_start_date|date:"Y.m.d" }} ~ {{ program.recruit_end_date|date:"Y.m.d" }}
            </div>
          {% endif %}

          <!-- âœ… í”„ë¡œê·¸ë¨ ì •ë³´ í‘œ -->
          <table class="table table-sm mb-3 text-center">
            <tbody>
              <tr>
                <th><i class="bi bi-list-task me-1"></i> í”„ë¡œê·¸ë¨ ìœ í˜•</th>
                <td>
                  {% for t in program.program_types.all %}
                    <span class="badge bg-primary">{{ t.name }}</span>
                  {% empty %}
                    <span class="text-muted">ì—†ìŒ</span>
                  {% endfor %}
                </td>
              </tr>
              <tr>
                <th style="width:30%;"><i class="bi bi-people-fill me-1"></i> ëŒ€ìƒ</th>
                <td>{{ program.get_target_range }}</td>
              </tr>
              <tr>
                <th><i class="bi bi-calendar-event me-1"></i> ìˆ˜ì—…ê¸°ê°„</th>
                <td>{{ program.start_date|date:"Y.m.d" }} ~ {{ program.end_date|date:"Y.m.d" }}</td>
              </tr>
              <tr>
                <th><i class="bi bi-list-ol me-1"></i> ìˆ˜ì—…íšŸìˆ˜</th>
                <td>
                  {% if program.get_schedule_summary %}
                    {{ program.get_schedule_summary }}
                  {% else %}
                    <span class="text-muted">ë¯¸ì§€ì •</span>
                  {% endif %}
                </td>
              </tr>
              
              <tr>
                <th class="align-middle"><i class="bi bi-people me-1"></i> ìˆ˜ì—…ì‹œê°„(ë°˜)</th>
                <td class="align-middle">
                  {% if program.classes.all %}
                    <div class="d-flex flex-wrap gap-2 justify-content-center align-items-center">
                      {% for c in program.classes.all %}
                        <span class="class-badge">
                          {{ c.name }} ({{ c.applications.count }} / {{ c.capacity }}ëª…)
                        </span>
                      {% endfor %}
                    </div>
                  {% else %}
                    <span class="text-muted">ë“±ë¡ëœ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <th><i class="bi bi-list-ol me-1"></i> ì´ìˆ˜ì—…íšŸìˆ˜</th>
                <td>{{ program.session_count }}íšŒ</td>
              </tr>  
              <tr>
                <th><i class="bi bi-person-badge me-1"></i> ê°•ì‚¬</th>
                <td>
                  {% if program.teacher %}
                    {{ program.teacher.user.get_full_name|default:program.teacher.user.username }}
                  {% else %}
                    <span class="text-muted">ë¯¸ì§€ì •</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <th><i class="bi bi-tools me-1"></i> êµêµ¬ì¬</th>
                <td>
                  {% if program.material %}
                    {{ program.material }}
                    {% if program.include_materials %}
                      <span class="text-success">(êµêµ¬ì¬í¬í•¨)</span>
                    {% else %}
                      <span class="text-muted">(êµêµ¬ì¬ë³„ë„)</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">ì—†ìŒ</span>
                  {% endif %}

                </td>
              </tr>
              <tr>
                <th><i class="bi bi-cash-coin me-1"></i> ìˆ˜ê°•ë£Œ(ì›”)</th>
                <td>{{ program.tuition|intcomma }}ì›
                  <!-- êµêµ¬ë¹„/ê°•ì‚¬ë£Œ: ê´€ë¦¬ì + ì„¼í„°ê°•ì‚¬ë§Œ -->
                  {% if user.is_staff or user.profile.user_type == "center_teacher" %}
                    <div class="mt-2 small text-muted">
                      <i class="bi bi-cash-stack me-1"></i> êµêµ¬ë¹„: {{ program.material_fee|intcomma }}ì› <br>
                      <i class="bi bi-cash me-1"></i> ìˆ˜ì—…ë£Œ: {{ program.base_fee|intcomma }}ì›
                    </div>
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>

          <!-- âœ… ì •ì› ë§ˆê° ê²½ê³  -->
          {% if program.is_full and program.status == 'open' %}
            <div class="alert alert-danger py-2 mb-3">
              <i class="bi bi-exclamation-triangle me-1"></i> ì´ í”„ë¡œê·¸ë¨ì€ ì •ì›ì´ ëª¨ë‘ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>
          {% endif %}

          <!-- ìƒì„¸ ì„¤ëª… -->
          <h6 class="mb-2 fw-bold"><i class="bi bi-file-text me-1"></i> ìƒì„¸ë‚´ìš©</h6>
          <p class="mb-4" style="white-space: pre-wrap;">{{ program.description }}</p>

          <!-- ë²„íŠ¼ ì˜ì—­ -->
          <div class="d-flex gap-2 mt-auto">
            <a href="{% url 'program_list' %}" class="btn btn-outline-secondary">ëª©ë¡</a>
            {% if can_apply and program.status == 'open' and not program.is_full %}
              <a href="{% url 'program_apply' program.id %}" class="btn btn-primary">ìˆ˜ê°•í•˜ê¸°</a>
            {% else %}
              <button class="btn btn-secondary" disabled>ì‹ ì²­ ë¶ˆê°€</button>
            {% endif %}
            {% if user.is_staff %}
              <a href="{% url 'program_edit' program.id %}" class="btn btn-warning">
                <i class="bi bi-pencil-square"></i> ìˆ˜ì •
              </a>
              <a href="{% url 'program_clone' program.id %}" class="btn btn-warning">
                <i class="bi bi-files"></i> ë³µì œ
              </a>
              <a href="{% url 'program_delete' program.id %}" class="btn btn-danger"
                 onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                <i class="bi bi-trash"></i> ì‚­ì œ
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… ê´€ë¦¬ì ì „ìš©: ëª¨ë“  ì‹ ì²­ì ëª©ë¡ -->
  {% if user.is_staff %}
    <div class="card mt-4 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-bold mb-0">
            <i class="bi bi-people-check me-1"></i>
            í”„ë¡œê·¸ë¨ ì‹ ì²­ ë° ìˆ˜ê°• í˜„í™©
          </h5>

          <!-- âœ… ìˆ˜ê°•ìƒ ë“±ë¡ ë²„íŠ¼ -->
          <button class="btn btn-sm btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#addStudentGlobalModal">
            <i class="bi bi-person-plus-fill"></i>
            ìˆ˜ê°•ìƒ ë“±ë¡
          </button>
        </div>
        
        <!-- ================= ìˆ˜ê°•ìƒ ë“±ë¡ ëª¨ë‹¬ ================= -->
        <div class="modal fade" id="addStudentGlobalModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">

              <form method="post" action="{% url 'program_enrollment_add_global' program.id %}">
                {% csrf_token %}

                <div class="modal-header">
                  <h5 class="modal-title">
                    <i class="bi bi-person-plus"></i> ìˆ˜ê°•ìƒ ë“±ë¡
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                  <!-- âœ… ë°˜ ì„ íƒ -->
                  <div class="mb-3">
                    <label class="form-label fw-bold">ë°˜ ì„ íƒ</label>
                    <select name="class_id" class="form-select" required>
                      <option value="">-- ë°˜ ì„ íƒ --</option>
                      {% for cls in program.classes.all %}
                        <option value="{{ cls.id }}">
                          {{ cls.name }} ({{ cls.enrollments.count }}/{{ cls.capacity }})
                        </option>
                      {% endfor %}
                    </select>
                  </div>

                  <!-- âœ… íšŒì› ê²€ìƒ‰ -->
                  <div class="row g-2 mb-3">
                    <div class="col-4">
                      <select id="memberType" class="form-select form-select-sm">
                        <option value="">ì „ì²´ ìœ í˜•</option>
                        <option value="student">í•™ìƒ</option>
                        <option value="parent">í•™ë¶€ëª¨</option>
                        <option value="pre_teacher">ì˜ˆë¹„ê°•ì‚¬</option>
                        <option value="teacher">ê°•ì‚¬</option>
                        <option value="center_teacher">ì„¼í„°ê°•ì‚¬</option>
                        <option value="institution">ê¸°ê´€</option>
                      </select>
                    </div>
                    <div class="col-8">
                      <input type="text"
                            id="memberSearch"
                            class="form-control form-control-sm"
                            placeholder="ì´ë¦„ ë˜ëŠ” ì•„ì´ë”” ê²€ìƒ‰">
                    </div>
                  </div>


                  <!-- âœ… ê²€ìƒ‰ ê²°ê³¼ -->
                  <ul class="list-group mb-3" id="memberResult"></ul>

                  <!-- âœ… í•™ë¶€ëª¨ ì„ íƒ ì‹œ ìë…€ ì„ íƒ -->
                  <div id="childSelectBox" class="mt-3 d-none">
                    <label class="form-label fw-bold">ìë…€ ì„ íƒ</label>
                    <select id="childStudentSelect" class="form-select"></select>

                  </div>

                  <!-- hidden -->
                  <input type="hidden" name="student_id" id="directStudentId">
                  <input type="hidden" name="student_type" id="studentType">

                  <div class="alert alert-warning small mt-3 mb-0">
                    âš  ì‹ ì²­ ì—†ì´ ë°”ë¡œ ìˆ˜ê°•ìƒìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.
                  </div>

                </div>

                <div class="modal-footer">
                  <button type="submit" class="btn btn-success">
                    ë“±ë¡
                  </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    ì·¨ì†Œ
                  </button>
                </div>

              </form>
            </div>
          </div>
        </div>




        {% if program.classes.all %}
          {% for cls in classes %}
            <h6 class="fw-bold mt-3">
              {{ cls.name }}
              <span class="badge bg-warning text-dark me-1">
                ì‹ ì²­ {{ cls.pending_applications|length }}ëª…
              </span>
              <span class="badge bg-success me-1">
                ìˆ˜ê°• {{ cls.enrollments.count }}ëª…
              </span>
              <span class="badge bg-secondary">
                ì •ì› {{ cls.capacity }}ëª…
              </span>

            </h6>
            <div class="table-responsive mb-3">
              <table class="table table-bordered table-sm text-center align-middle">
                <thead class="table-light">
                  <tr>
                    <th>í•™ìƒ</th>
                    <th>ì—°ë½ì²˜</th>
                    <th>êµ¬ë¶„</th>
                    <th>ìƒíƒœ</th>
                    <th>ë“±ë¡ì¼</th>
                    <th>ê´€ë¦¬</th>
                  </tr>
                </thead>

                <tbody>
                  {% for enroll in cls.enrollments.all %}
                    <tr class="table-success">
                      <td>{{ enroll.student.user.get_full_name|default:enroll.student.user.username }}</td>
                      <td>-</td>
                      <td><span class="badge bg-success">ìˆ˜ê°•ì¤‘</span></td>
                      <td>ì •ìƒ</td>
                      <td>{{ enroll.enrolled_at|date:"Y.m.d" }}</td>
                      <td>
                        <form method="post"
                              action="{% url 'cancel_enrollment' enroll.id %}"
                              onsubmit="return confirm('ì •ë§ ìˆ˜ê°•ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                              class="m-0">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-outline-danger">
                            ìˆ˜ê°•ì·¨ì†Œ
                          </button>
                        </form>
                      </td>

                    </tr>
                  {% endfor %}
                  {% for app in cls.applications.all %}
                    {% if app.status == "pending" %}
                      <tr>
                        <td>
                          {% if app.child %}
                            {{ app.child.name }}
                          {% else %}
                            -
                          {% endif %}
                        </td>

                        <td>{{ app.phone }}</td>

                        <td>
                          <span class="badge bg-warning text-dark">ì‹ ì²­</span>
                        </td>

                        <td>
                          <span class="badge bg-warning text-dark">
                            ì‹ ì²­ì ‘ìˆ˜
                          </span>
                        </td>

                        <td>{{ app.applied_at|date:"Y.m.d" }}</td>

                        <td class="text-center align-middle">
                          <div class="d-flex justify-content-center align-items-center h-100 gap-1">

                            <!-- ìŠ¹ì¸ -->
                            <form method="post"
                                  action="{% url 'convert_to_enrollment' app.id %}"
                                  class="m-0"
                                  onsubmit="return confirm('ìˆ˜ê°•ìƒìœ¼ë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                              {% csrf_token %}
                              <button class="btn btn-sm btn-success">ìŠ¹ì¸</button>
                            </form>

                            <!-- ë°˜ë ¤ -->
                            <form method="post"
                                  action="{% url 'reject_application' app.id %}"
                                  class="m-0"
                                  onsubmit="return confirm('ì‹ ì²­ì„ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                              {% csrf_token %}
                              <button class="btn btn-sm btn-warning">ë°˜ë ¤</button>
                            </form>

                            <!-- ì‚­ì œ -->
                            <form method="post"
                                  action="{% url 'delete_application' app.id %}"
                                  class="m-0"
                                  onsubmit="return confirm('ì‹ ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                              {% csrf_token %}
                              <button class="btn btn-sm btn-danger">ì‚­ì œ</button>
                            </form>

                          </div>
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}


                </tbody>
              </table>
            </div>

          {% endfor %}
        {% else %}
          <p class="text-muted">ë“±ë¡ëœ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
      </div>
    </div>
  {% elif user.is_authenticated and user.profile.user_type == "parent" %}
    <div class="card mt-4 shadow-sm">
      <div class="card-body">
        <h5 class="fw-bold mb-3">
          <i class="bi bi-check2-circle me-1"></i> ë‚´ ìë…€ ë°˜ë³„ ì‹ ì²­ í˜„í™©
        </h5>

        {% if classes %}
          {% for cls in classes %}
            <h6 class="fw-bold mt-3">{{ cls.name }}</h6>
            <div class="table-responsive mb-3">
              <table class="table table-bordered table-sm text-center align-middle">
                <thead class="table-light">
                  <tr>
                    <th>ìë…€ ì´ë¦„</th>
                    <th>ìƒë…„ì›”ì¼</th>
                    <th>ì‹ ì²­ ìƒíƒœ</th>
                    <th>ì‹ ì²­ì¼</th>
                  </tr>
                </thead>
                <tbody>

                  {# âœ… 1. ìˆ˜ê°•ì¤‘ (Enrollment) #}
                  {% for enroll in cls.active_enrollments %}
                    {% if enroll.student and enroll.student.parent == user.profile %}
                      <tr class="table-success">
                        <td>{{ enroll.student.name }}</td>
                        <td>{{ enroll.student.birth_date|date:"Y.m.d" }}</td>
                        <td>
                          <span class="badge bg-success text-white">ìˆ˜ê°•ì¤‘</span>
                        </td>
                        <td>{{ enroll.enrolled_at|date:"Y.m.d" }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}

                  {# âœ… 2. ì‹ ì²­ì¤‘ / ìŠ¹ì¸ / ë°˜ë ¤ (Application) #}
                  {% for app in cls.applications.all %}
                    {% if app.child and app.applicant == user.profile %}
                      <tr>
                        <td>{{ app.child.name }}</td>
                        <td>{{ app.child.birth_date|date:"Y.m.d" }}</td>
                        <td>
                          <span class="badge
                            {% if app.status == 'pending' %}
                              bg-warning text-dark
                            {% elif app.status == 'approved' %}
                              bg-success text-white
                            {% elif app.status == 'rejected' %}
                              bg-danger text-white
                            {% else %}
                              bg-secondary text-white
                            {% endif %}
                          ">
                            {{ app.get_status_display }}
                          </span>
                        </td>
                        <td>{{ app.applied_at|date:"Y.m.d" }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}

                  {% if cls.active_enrollments|length == 0 and cls.applications.count == 0 %}
                    <tr>
                      <td colspan="4" class="text-center text-muted py-3">
                        ë‚´ ìë…€ ì‹ ì²­/ìˆ˜ê°• ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                      </td>
                    </tr>
                  {% endif %}

                </tbody>
              </table>
            </div>
          {% endfor %}
        {% endif %}
      </div>
    </div>
  {% endif %}


</div>

<style>
.card table th {
  text-align: center;
  background: #f8f9fa;
  font-weight: 600;
  font-size: 0.85rem;
}
.card table td {
  text-align: center;
  font-size: 0.85rem;
  vertical-align: middle;  /* âœ… ì„¸ë¡œ ê°€ìš´ë° ì •ë ¬ */
}

/* ë°˜ë³„ ë±ƒì§€ ìƒ‰ìƒ */
.class-badge:nth-child(1) { background-color: #0d6efd !important; }  /* íŒŒë‘ */
.class-badge:nth-child(2) { background-color: #198754 !important; }  /* ì´ˆë¡ */
.class-badge:nth-child(3) { background-color: #fd7e14 !important; }  /* ì£¼í™© */
.class-badge:nth-child(4) { background-color: #6f42c1 !important; }  /* ë³´ë¼ */
.class-badge:nth-child(5) { background-color: #20c997 !important; }  /* ì²­ë¡ */
.class-badge:nth-child(6) { background-color: #d63384 !important; }  /* í•‘í¬ */
.class-badge:nth-child(7) { background-color: #0dcaf0 !important; }  /* í•˜ëŠ˜ */
.class-badge:nth-child(8) { background-color: #ffc107 !important; }  /* ë…¸ë‘ */

.class-badge {
  display: inline-block;
  font-size: 0.9rem;
  padding: 0.5em 0.75em;
  border-radius: 0.65rem;
  color: #fff !important;
}
</style>
<script>
const searchInput = document.getElementById("memberSearch");
const typeSelect = document.getElementById("memberType");
const resultBox = document.getElementById("memberResult");
const childBox = document.getElementById("childSelectBox");
const directStudentInput = document.getElementById("directStudentId");

function searchMembers() {
  const q = searchInput.value;
  const type = typeSelect.value;

  if (!q && !type) {
    resultBox.innerHTML = "";
    return;
  }

  fetch(`/courses/api/members/search/?q=${q}&user_type=${type}`)
    .then(res => res.json())
    .then(data => {
      resultBox.innerHTML = "";
      childBox.classList.add("d-none");
      directStudentInput.value = "";

      data.forEach(m => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";

        li.innerHTML = `
          <span>
            <strong>${m.name}</strong>
            <small class="text-muted ms-1">(${m.user_type})</small>
          </span>
          <button type="button"
                  class="btn btn-sm btn-outline-primary select-btn">
            ì„ íƒ
          </button>
        `;

        li.querySelector(".select-btn").addEventListener("click", () => {
          selectMember(m, li);
        });

        resultBox.appendChild(li);
      });
    });

}

searchInput.addEventListener("keyup", searchMembers);
typeSelect.addEventListener("change", searchMembers);

function selectMember(member, liElement) {

  // ğŸ”¹ ëª¨ë“  í•­ëª© ì„ íƒ í•´ì œ
  document.querySelectorAll("#memberResult .list-group-item")
    .forEach(item => {
      item.classList.remove("active");
      const btn = item.querySelector("button");
      btn.classList.remove("btn-success");
      btn.classList.add("btn-outline-primary");
      btn.textContent = "ì„ íƒ";
    });

  // ğŸ”¹ í˜„ì¬ ì„ íƒ í•­ëª© í‘œì‹œ
  liElement.classList.add("active");
  const btn = liElement.querySelector("button");
  btn.classList.remove("btn-outline-primary");
  btn.classList.add("btn-success");
  btn.textContent = "ì„ íƒë¨";

  // ğŸ”¹ ì´ˆê¸°í™”
  childBox.classList.add("d-none");
  directStudentInput.value = "";

  if (member.user_type === "student") {
    directStudentInput.value = member.profile_id || member.id;
    document.getElementById("studentType").value = "student";
    childBox.classList.add("d-none");
  }

  else if (member.user_type === "parent") {
    document.getElementById("studentType").value = "child";

    fetch(`/accounts/api/parent/${member.profile_id}/children/`)
      .then(res => res.json())
      .then(children => {
        const select = document.getElementById("childStudentSelect");
        select.innerHTML = "";

        children.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.name;
          select.appendChild(opt);
        });

        select.onchange = () => {
          directStudentInput.value = select.value;
        };

        childBox.classList.remove("d-none");
      });
  }


}

</script>

{% endblock %}
