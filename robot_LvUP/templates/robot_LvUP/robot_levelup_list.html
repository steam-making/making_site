
{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load levelup_extras %}

{% block content %}
<link rel="stylesheet" href="{% static 'robot_LvUP/css/robot_levelup.css' %}">
<div class="container mt-4">

  <!-- ğŸ”¹ í—¤ë” -->
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <h4 class="m-0">
      <i class="bi bi-bar-chart-steps me-2 text-primary"></i>
      <span class="fw-semibold">{{ institution.name }}</span>
      <small class="text-muted">({{ institution.program }}) ë‹¨ê³„ì—… ê´€ë¦¬</small>
    </h4>

    <div class="d-flex align-items-center gap-2 flex-nowrap levelup-toolbar">

      <!-- ì›” í•„í„° -->
      <select class="form-select form-select-sm levelup-month"
              onchange="filterMonth(this.value)">
        <option value="">ì „ì²´ ì›”</option>
        {% for ym in grouped_records.keys %}
          <option value="{{ ym }}">{{ ym }}</option>
        {% endfor %}
      </select>

      <!-- ë²„íŠ¼ë“¤ -->
      <a href="{% url 'robot_levelup_create' institution.id %}"
        class="btn btn-success btn-sm d-flex align-items-center gap-1">
        <i class="bi bi-plus-circle"></i> ë‹¨ê³„ì—… ë“±ë¡
      </a>

      <a href="{% url 'levelup_dashboard' %}"
        class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-1">
        <i class="bi bi-bar-chart"></i> í†µê³„ ë³´ê¸°
      </a>

      <a href="{% url 'students:student_list' %}"
        class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1">
        <i class="bi bi-arrow-left"></i> ì¶œê°•ì¥ì†Œ
      </a>

      <button class="btn btn-warning btn-sm d-flex align-items-center gap-1"
              onclick="selectReleaseMonth()">
        <i class="bi bi-box-arrow-up"></i> ì¶œê³ ë“±ë¡
      </button>

    </div>
  </div>

  {% if undelivered_materials %}
      <div class="card border-warning shadow-sm mb-4">
        <div class="card-body">

          <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
            <i class="bi bi-exclamation-triangle-fill text-warning"></i>

            <span class="badge bg-dark">
              ì¶œê³  ì™„ë£Œ {{ release_done }}ê°œ / ì „ë‹¬ ë¯¸ì™„ë£Œ êµêµ¬ {{ undelivered_total_qty }}ê°œ)
            </span>
          </div>


          <div class="d-flex flex-wrap gap-2">
            {% for m in undelivered_materials %}
              <span class="badge 
                {% cycle 'bg-primary' 'bg-success' 'bg-warning text-dark' 'bg-danger' 'bg-info text-dark' 'bg-secondary' %}
                px-3 py-2">
                {{ m.material__name }} : {{ m.qty }}ê°œ
              </span>
            {% endfor %}
          </div>

        </div>
      </div>
  {% endif %}

  <!-- ğŸ”¹ ë‹¨ê³„ì—… ë¦¬ìŠ¤íŠ¸ (records ìœ ì§€ + ì›” í—¤ë” ì‚½ì…) -->
  <div class="table-responsive">
    <table class="table table-striped table-hover table-stack align-middle text-center">
      <thead class="table-light">
        <tr>
          <th>ë…„ì›”</th><th>êµêµ¬ëª…</th><th>ë¶€</th><th>í•™ë…„</th><th>ë°˜</th><th>ë²ˆí˜¸</th><th>í•™ìƒëª…</th>
          <th>ì•ˆë‚´</th><th>ì¶œê³ </th><th>ì „ë‹¬</th><th>ê°€ê²©</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th>
        </tr>
      </thead>
      <tbody>

        {% for r in records %}
          {# ğŸ”¹ ì›”ì´ ë°”ë€” ë•Œë§Œ í—¤ë” ì¶œë ¥ #}
          {% ifchanged r.year_month %}
          <tr class="table-secondary month-header cursor-pointer"
              data-month="{{ r.year_month }}"
              onclick="toggleMonth('{{ r.year_month }}')">
            <td colspan="13" class="text-start fw-semibold py-2">

              <i class="bi bi-calendar-event me-2"></i>
              <span class="me-3">{{ r.year_month }}</span>

              {% if monthly_stats and monthly_stats.r_year_month %}
              {% endif %}

              {% with stat=monthly_stats.r_year_month %}
              {% endwith %}

              {% if monthly_stats %}
                {% for ym, stat in monthly_stats.items %}
                  {% if ym == r.year_month %}
                    <!-- ì•ˆë‚´ -->
                    <span class="badge bg-success ms-1">
                      ì•ˆë‚´ {{ stat.guide_done }}/{{ stat.total }}
                    </span>

                    <!-- ì¶œê³  -->
                    <span class="badge bg-warning text-dark ms-1">
                      ì¶œê³  {{ stat.release_done }}/{{ stat.total }}
                    </span>

                    <!-- ì „ë‹¬ -->
                    <span class="badge bg-info text-dark ms-1">
                      ì „ë‹¬ {{ stat.delivered }}/{{ stat.total }}
                    </span>

                    {% if stat.release_materials %}
                      <span class="month-material-scroll ms-2">
                        {% for name, qty in stat.release_materials.items %}
                          <span class="material-chip 
                            {% cycle 'mc-blue' 'mc-green' 'mc-yellow' 'mc-red' 'mc-cyan' 'mc-gray' %}">
                            <span class="material-name">{{ name }}</span>
                            <span class="material-qty">{{ qty }}</span>
                          </span>
                        {% endfor %}
                      </span>
                    {% endif %}

                  {% endif %}
                {% endfor %}
              {% endif %}

            </td>
          </tr>
          {% endifchanged %}



          <tr class="month-row d-none" data-month="{{ r.year_month }}">

            <td>{{ r.year_month }}</td>
            <td>{{ r.material.name }}</td>
            <td>{{ r.section }}</td>
            <td>{{ r.grade }}</td>
            <td>{{ r.class_no }}</td>
            <td>{{ r.student_no }}</td>
            <td class="fw-semibold">{{ r.student_name }}</td>

            <!-- ê¸°ì¡´ í† ê¸€ ë²„íŠ¼ ì „ë¶€ ìœ ì§€ -->
            <td class="text-center">
              <button class="btn btn-sm toggle-btn {% if r.guide_done %}btn-success{% else %}btn-outline-success{% endif %}"
                      data-id="{{ r.pk }}" data-field="guide">
                {% if r.guide_done %}
                  âœ… <small class="text-muted ms-1">{{ r.guide_date|date:"y.m.d" }}</small>
                {% else %}
                  ì•ˆë‚´
                {% endif %}
              </button>
            </td>

            <td class="text-center">
              <button class="btn btn-sm toggle-btn {% if r.release_done %}btn-warning{% else %}btn-outline-warning{% endif %}"
                      data-id="{{ r.pk }}" data-field="release">
                {% if r.release_done %}
                  âœ… <small class="text-muted ms-1">{{ r.release_date|date:"y.m.d" }}</small>
                {% else %}
                  ì¶œê³ 
                {% endif %}
              </button>
            </td>

            <td class="text-center">
              <button class="btn btn-sm toggle-btn {% if r.delivery_done %}btn-primary{% else %}btn-outline-primary{% endif %}"
                      data-id="{{ r.pk }}" data-field="delivery">
                {% if r.delivery_done %}
                  âœ… <small class="text-muted ms-1">{{ r.delivery_date|date:"y.m.d" }}</small>
                {% else %}
                  ì „ë‹¬
                {% endif %}
              </button>
            </td>

            <td class="text-end">{{ r.price|intcomma }}ì›</td>
            <td>{{ r.note|default:"-" }}</td>

            <td>
              <a href="{% url 'robot_levelup_update' r.pk %}" class="btn btn-sm btn-outline-secondary">ìˆ˜ì •</a>
              <a href="{% url 'robot_levelup_delete' r.pk %}"
                 class="btn btn-sm btn-outline-danger"
                 onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                 <i class="bi bi-trash"></i>
              </a>
            </td>
          </tr>
        {% empty %}
        <tr>
          <td colspan="13" class="text-center text-muted">
            ë“±ë¡ëœ ë‹¨ê³„ì—… í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.
          </td>
        </tr>
        {% endfor %}

      </tbody>
    </table>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const recordId = btn.dataset.id;
      const field = btn.dataset.field;
      const url = `/robot_LvUP/toggle/${recordId}/${field}/`;

      try {
        const res = await fetch(url, {
          method: 'GET',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await res.json();

        if (!data.success) return;

        // âœ… ë‚ ì§œ ì—˜ë¦¬ë¨¼íŠ¸ ì¦‰ì‹œ ì œê±°
        let dateElem = btn.parentElement.querySelector('small');
        if (dateElem) dateElem.remove();

        // âœ… ìƒíƒœ í† ê¸€
        if (data.done) {
          // âœ… í•œ ì¤„ë¡œ í‘œì‹œ (ì²´í¬ + ë‚ ì§œ)
          const todayText = data.date ? `âœ… ${data.date}` : 'âœ…';
          btn.innerHTML = todayText;

          btn.classList.remove('btn-outline-success', 'btn-outline-warning', 'btn-outline-primary');
          if (field === 'guide') btn.classList.add('btn-success');
          if (field === 'release') btn.classList.add('btn-warning');
          if (field === 'delivery') btn.classList.add('btn-primary');

        } else {
          // âŒ í•´ì œ ìƒíƒœ
          if (field === 'guide') {
            btn.className = 'btn btn-sm btn-outline-success toggle-btn';
            btn.textContent = 'ì•ˆë‚´';
          } else if (field === 'release') {
            btn.className = 'btn btn-sm btn-outline-warning toggle-btn';
            btn.textContent = 'ì¶œê³ ';
          } else if (field === 'delivery') {
            btn.className = 'btn btn-sm btn-outline-primary toggle-btn';
            btn.textContent = 'ì „ë‹¬';
          }
        }

      } catch (err) {
        console.error('í† ê¸€ ì˜¤ë¥˜:', err);
      }
    });
  });
});

function openReleaseMonthSelector() {
    const today = new Date();

    // â­ ë‹¤ìŒë‹¬ ê³„ì‚°
    let year = today.getFullYear();
    let month = today.getMonth() + 2; // í˜„ì¬ë‹¬ + 1 â‡’ JSëŠ” 0ë¶€í„° ì‹œì‘ì´ë¯€ë¡œ +2

    if (month === 13) {
        month = 1;
        year += 1;
    }

    const defaultYM = `${year}-${String(month).padStart(2, '0')}`;

    // â­ ì‚¬ìš©ìì—ê²Œ ì„ íƒì°½ ë³´ì—¬ì£¼ê¸°
    const selected = prompt("ì¶œê³ í•  ë…„ì›”ì„ ì„ íƒí•˜ì„¸ìš”. (ì˜ˆ: 2025-12)", defaultYM);

    if (!selected) return;  // ì·¨ì†Œí•˜ë©´ ì•„ë¬´ ê²ƒë„ ì•ˆí•¨

    // â­ ì •ê·œì‹ ê²€ì¦ (YYYY-MM)
    if (!/^\d{4}-\d{2}$/.test(selected)) {
        alert("í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ˆ: 2025-12");
        return;
    }

    // URL ì´ë™
    const institutionId = "{{ institution.id }}";
    const url = `/robot_LvUP/${institutionId}/release_auto/${selected}/`;

    if (confirm(`${selected} ë‹¨ê³„ì—… êµêµ¬ë¥¼ ìë™ ì¶œê³ ë“±ë¡ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        window.location.href = url;
    }
}

function selectReleaseMonth() {

    // ì˜¤ëŠ˜ ê¸°ì¤€ ë‹¤ìŒë‹¬ ê¸°ë³¸ê°’
    const today = new Date();
    let year = today.getFullYear();
    let month = today.getMonth() + 2;

    if (month === 13) {
        month = 1;
        year++;
    }

    const defaultYM = `${year}-${String(month).padStart(2, '0')}`;

    // ì‚¬ìš©ì ì…ë ¥
    const ym = prompt("ì¶œê³ í•  ë…„ì›”ì„ ì„ íƒí•˜ì„¸ìš” (ì˜ˆ: 2025-12)", defaultYM);

    if (!ym) return;

    if (!/^\d{4}-\d{2}$/.test(ym)) {
        alert("í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ˆ: 2025-12");
        return;
    }

    // ì¶œê³  ë¯¸ë¦¬ë³´ê¸° í˜ì´ì§€ë¡œ ì´ë™
    const institutionId = "{{ institution.id }}";
    const url = `/robot_LvUP/${institutionId}/release_preview/${ym}/`;

    window.location.href = url;
}

function toggleMonth(month) {
  document.querySelectorAll(`.month-row[data-month="${month}"]`)
    .forEach(tr => tr.classList.toggle('d-none'));
}

function filterMonth(month) {
  document.querySelectorAll('.month-header, .month-row')
    .forEach(el => {
      if (!month || el.dataset.month === month) {
        el.classList.remove('d-none');
      } else {
        el.classList.add('d-none');
      }
    });
}
</script>



{% endblock %}
