{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="container mt-4">
  <h4 class="mb-3">
    {% if record %}
      <i class="bi bi-pencil-square me-1"></i> 로봇 단계업 수정
    {% else %}
      <i class="bi bi-robot me-1"></i> 로봇 단계업 등록
    {% endif %}
  </h4>

  <form method="post">
    {% csrf_token %}
    <div class="mb-3">
      <label class="form-label">년도-월</label>
      <!-- ✅ 수정에서도 입력 가능하도록 readonly 제거 -->
      <input type="month" name="year_month" id="yearMonthInput" class="form-control"
             value="{{ record.year_month|default:'' }}" required>
    </div>

    <table class="table table-bordered table-sm align-middle text-center">
      <thead class="table-light">
        <tr>
          <th style="width:50px;">#</th>
          <th>교구명</th>
          <th>부</th>
          <th>학년</th>
          <th>반</th>
          <th>번호</th>
          <th>학생명</th>
          <th>가격</th>
          <th>비고</th>
          {% if not record %}<th>삭제</th>{% endif %}
        </tr>
      </thead>
      <tbody id="rowContainer">

        {% if record %}
        <!-- ✅ 수정 모드용 단일 행 -->
        <tr>
          <td class="row-index text-muted">1</td>
          <td>
            <select name="material" class="form-select form-select-sm text-center" required>
              {% for m in robot_materials %}
                <option value="{{ m.id }}" {% if record.material.id == m.id %}selected{% endif %}>
                  {{ m.name }}
                </option>
              {% endfor %}
            </select>
          </td>
          <td><input type="text" name="section" class="form-control form-control-sm text-center" value="{{ record.section }}"></td>
          <td><input type="text" name="grade" class="form-control form-control-sm text-center" value="{{ record.grade }}"></td>
          <td><input type="text" name="class_no" class="form-control form-control-sm text-center" value="{{ record.class_no }}"></td>
          <td><input type="text" name="student_no" class="form-control form-control-sm text-center" value="{{ record.student_no }}"></td>
          <td><input type="text" name="student_name" class="form-control form-control-sm text-center" value="{{ record.student_name }}"></td>
          <td><input type="number" name="price" class="form-control form-control-sm text-center" value="{{ record.price }}"></td>
          <td><input type="text" name="note" class="form-control form-control-sm text-center" value="{{ record.note }}"></td>
        </tr>

        {% else %}
        <!-- ✅ 등록 모드용 행 -->
        <tr>
          <td class="row-index text-muted">1</td>
          <td class="position-relative">
            <input type="hidden" name="material_id_1">
            <input type="text" name="material_name_1" class="form-control form-control-sm text-center material-input"
                   placeholder="교구명 입력" autocomplete="off">
            <div class="autocomplete-list border bg-white rounded shadow-sm position-absolute w-100 d-none"
                 style="z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
          </td>
          <td><input type="text" name="part_1" class="form-control form-control-sm text-center readonly-field" readonly></td>
          <td><input type="text" name="grade_1" class="form-control form-control-sm text-center readonly-field" readonly></td>
          <td><input type="text" name="class_name_1" class="form-control form-control-sm text-center readonly-field" readonly></td>
          <td><input type="text" name="number_1" class="form-control form-control-sm text-center readonly-field" readonly></td>

          <td class="position-relative">
            <input type="text" name="student_name_1" class="form-control form-control-sm text-center student-input"
                   placeholder="학생 이름 입력" autocomplete="off">
            <div class="autocomplete-list border bg-white rounded shadow-sm position-absolute w-100 d-none"
                 style="z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
          </td>
          <td><input type="number" name="price_1" class="form-control form-control-sm text-center price-input" readonly></td>
          <td><input type="text" name="note_1" class="form-control form-control-sm text-center"></td>
          <td class="text-center"><button type="button" class="btn btn-sm btn-danger remove-row">x</button></td>
        </tr>
        {% endif %}

      </tbody>
    </table>

    {% if not record %}
    <input type="hidden" name="row_count" id="rowCount" value="1">
    <div class="d-flex justify-content-between">
      <button type="button" id="addRow" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-plus-circle"></i> 행 추가
      </button>
      <button type="submit" class="btn btn-success">
        <i class="bi bi-check2-circle"></i> 저장
      </button>
    </div>
    {% else %}
    <div class="d-flex justify-content-between">
      <a href="{% url 'robot_levelup_by_institution' institution.id %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> 목록으로
      </a>
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-save"></i> 수정 완료
      </button>
    </div>
    {% endif %}
  </form>
</div>

<style>
  .readonly-field {
    background-color: #f8f9fa !important;
    cursor: not-allowed !important;
    color: #6c757d !important;
  }
  .autocomplete-item { padding: 4px 8px; cursor: pointer; }
  .autocomplete-item:hover { background-color: #f1f1f1; }
</style>

{% if not record %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ✅ 다음달 자동 입력
  const today = new Date();
  today.setMonth(today.getMonth() + 1);
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const yearMonthInput = document.getElementById('yearMonthInput');
  if (yearMonthInput && !yearMonthInput.value) {
    yearMonthInput.value = `${year}-${month}`;
  }

  let rowCount = 1;
  const rowContainer = document.getElementById('rowContainer');

  // ✅ 행 추가
  document.getElementById('addRow').addEventListener('click', function() {
    rowCount++;
    const newRow = rowContainer.firstElementChild.cloneNode(true);
    newRow.querySelectorAll('input').forEach(el => {
      const name = el.getAttribute('name');
      if (name) el.setAttribute('name', name.replace(/\d+$/, rowCount));
      el.value = '';
    });
    newRow.querySelector('.row-index').textContent = rowCount;
    rowContainer.appendChild(newRow);
    document.getElementById('rowCount').value = rowCount;
  });

  // ✅ 행 삭제
  rowContainer.addEventListener('click', e => {
    if (e.target.classList.contains('remove-row')) {
      const rows = rowContainer.querySelectorAll('tr');
      if (rows.length > 1) {
        e.target.closest('tr').remove();
        rowContainer.querySelectorAll('.row-index').forEach((cell, idx) => {
          cell.textContent = idx + 1;
        });
        rowCount = rowContainer.querySelectorAll('tr').length;
        document.getElementById('rowCount').value = rowCount;
      }
    }
  });

  // ✅ 학생/교구 자동완성용 데이터
  const students = [
    {% for s in students %}
      {% if s.division and "미수강" not in s.division.division %}
      {
        name: "{{ s.name }}",
        grade: "{{ s.grade }}",
        class_name: "{{ s.class_name }}",
        number: "{{ s.number }}",
        division: "{{ s.division.division|default_if_none:'' }}"
      },
      {% endif %}
    {% endfor %}
  ];

  const materials = [
    {% for m in robot_materials %}
      { id: "{{ m.id }}", name: "{{ m.name }}", price: "{{ m.school_price }}" },
    {% endfor %}
  ];

  // ✅ 자동완성 함수
  function setupAutocomplete(inputClass, dataset, onSelect) {
    document.addEventListener('input', function(e) {
      if (e.target.classList.contains(inputClass)) {
        const input = e.target;
        const listDiv = input.parentElement.querySelector('.autocomplete-list');
        const keyword = input.value.trim();
        listDiv.innerHTML = '';
        if (keyword.length > 0) {
          const filtered = dataset.filter(item => item.name.includes(keyword));
          if (filtered.length) {
            filtered.forEach(item => {
              const div = document.createElement('div');
              div.classList.add('autocomplete-item');
              div.textContent = inputClass === 'student-input'
                ? `${item.name} (${item.grade}-${item.class_name}-${item.number})`
                : `${item.name}`;
              div.addEventListener('click', () => onSelect(item, input, listDiv));
              listDiv.appendChild(div);
            });
            listDiv.classList.remove('d-none');
          } else listDiv.classList.add('d-none');
        } else listDiv.classList.add('d-none');
      }
    });

    document.addEventListener('click', e => {
      document.querySelectorAll('.autocomplete-list').forEach(list => {
        if (!list.contains(e.target) && !list.previousElementSibling.contains(e.target))
          list.classList.add('d-none');
      });
    });
  }

  // ✅ 학생 선택 시 자동 채우기
  setupAutocomplete('student-input', students, (s, input, list) => {
    input.value = s.name;
    list.classList.add('d-none');
    const row = input.closest('tr');
    row.querySelector('input[name^="part_"]').value = s.division;
    row.querySelector('input[name^="grade_"]').value = s.grade;
    row.querySelector('input[name^="class_name_"]').value = s.class_name;
    row.querySelector('input[name^="number_"]').value = s.number;
  });

  // ✅ 교구 선택 시 자동 채우기
  setupAutocomplete('material-input', materials, (m, input, list) => {
    input.value = m.name;
    list.classList.add('d-none');
    const row = input.closest('tr');
    row.querySelector('input[name^="material_id_"]').value = m.id;
    row.querySelector('.price-input').value = m.price;
  });
});
</script>
{% endif %}
{% endblock %}
