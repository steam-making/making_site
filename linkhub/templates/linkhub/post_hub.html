{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'linkhub/css/department.css' %}">
<link rel="stylesheet" href="{% static 'linkhub/css/post_hub.css' %}">

<div class="container">

    <!-- ===== ÏÉÅÎã® ===== -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">

        <!-- üîπ Ï†úÎ™© -->
        <h4 class="mb-0 d-flex align-items-center gap-2">
            <i class="bi bi-megaphone"></i>
            Î™®Ïßë / Í≥µÏßÄ ÌÜµÌï© Î≥¥Í∏∞
        </h4>

        {% if request.user.is_staff %}
        <!-- üîπ Í¥ÄÎ¶¨Ïûê Î≤ÑÌäº ÏòÅÏó≠ -->
        <div class="d-flex align-items-center gap-2 flex-wrap">

            <!-- üîπ ÏàòÏßë Í∏∞Ï§ÄÏùº -->
           {% if request.user.is_staff %}
            <span class="badge bg-secondary d-inline-flex align-items-center gap-1"
                style="cursor:pointer;"
                onclick="openCutoffEditor()">

                <span id="cutoff-label">
                    ÏàòÏßë Í∏∞Ï§ÄÏùº: {{ cutoff_date }}
                </span>

                <i class="bi bi-pencil"></i>
            </span>

            <input type="date"
                id="cutoff-input"
                value="{{ cutoff_date|date:'Y-m-d' }}"
                class="form-control form-control-sm d-none"
                style="width: 150px;"
                onchange="saveCutoffDate(this.value)">
            {% else %}
            <span class="badge bg-secondary">
                ÏàòÏßë Í∏∞Ï§ÄÏùº: {{ cutoff_date }}
            </span>
            {% endif %}


            <!-- üîπ ÏµúÍ∑º ÏàòÏßëÏùº -->
            <span class="badge bg-light text-dark border d-flex align-items-center px-2 py-1">
                <i class="bi bi-clock-history me-1 text-secondary"></i>
                <small class="text-muted">ÏµúÍ∑º ÏàòÏßë</small>
                <strong class="ms-1">
                    {% if latest_collected_date %}
                        {{ latest_collected_date }}
                    {% else %}
                        ÏóÜÏùå
                    {% endif %}
                </strong>
            </span>

            <!-- ÎäòÎ¥Ñ ÏàòÏßë -->
            <form method="post"
                action="{% url 'linkhub:collect' %}"
                class="m-0">
                {% csrf_token %}
                <input type="hidden" name="area" value="{{ area }}">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-arrow-repeat"></i>
                    ÎäòÎ¥ÑÏàòÏßë
                </button>
            </form>

            <!-- SourceSite Í¥ÄÎ¶¨ -->
            <a href="{% url 'linkhub:source_list' %}"
            class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-gear"></i>
                SourceSite
            </a>

            <!-- Î™®Îëê ÏÇ≠Ï†ú -->
            <form method="post"
                action="{% url 'linkhub:delete_all' %}"
                class="m-0"
                onsubmit="return confirm('Ï†ïÎßê Î™®Îëê ÏÇ≠Ï†úÌï†ÍπåÏöî? (Î≥µÍµ¨ Î∂àÍ∞Ä)');">
                {% csrf_token %}
                <input type="hidden" name="area" value="{{ area }}">
                <button type="submit" class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-trash"></i>
                    Ï†ÑÏ≤¥ÏÇ≠Ï†ú
                </button>
            </form>

        </div>
        {% endif %}
    </div>
        

    {% if area == "jeonnam" %}

        <form method="get" id="filterForm" class="mb-3">

            <input type="hidden" name="area" value="{{ area }}">

            <div class="card p-3 mb-3">
                <div class="fw-bold mb-2">
                    <i class="bi bi-diagram-3"></i> Í≥µÍ≥† Ï∂úÏ≤ò ÏÑ†ÌÉù
                </div>

                <div class="d-flex flex-wrap gap-2">
                    <!-- Ï†ÑÏ≤¥ -->
                    <label class="form-check form-check-inline">
                        <input class="form-check-input auto-submit"
                            type="radio"
                            name="source"
                            value=""
                            {% if not selected.source %}checked{% endif %}>
                        <span class="badge bg-dark">Ï†ÑÏ≤¥</span>
                    </label>

                    {% for s in sources %}
                    <label class="form-check form-check-inline">
                        <input class="form-check-input auto-submit"
                            type="radio"
                            name="source"
                            value="{{ s.id }}"
                            {% if selected.source == s.id|stringformat:"s" %}checked{% endif %}>
                            <span class="badge {{ s.badge_class }}">
                                {{ s.name }}
                            </span>
                    </label>

                    {% endfor %}
                </div>
            </div>

        </form>

        <!-- ===============================
        Ï†ÑÎÇ® : Í∑∏Î£π ÏóÜÎäî Î¶¨Ïä§Ìä∏
        =============================== -->
        <div class="card mb-3">


            <table class="table table-hover table-stack align-middle mb-0">
                <colgroup>
                    <col style="width:60%">
                    <col style="width:10%">
                    <col style="width:15%">
                </colgroup>
                <thead class="table-light">
                    <tr>
                        <th class="text-start">Ï†úÎ™©</th>
                        <th class="text-center">ÌååÏùº</th>
                        <th class="text-center">ÎßÅÌÅ¨</th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in groups %}
                        {% for post in group.posts %}
                        <tr>
                            <td data-label="Ï†úÎ™©" class="text-start">

                                <!-- üîπ Ï†úÎ™© Ïïû Î©îÌÉÄ Ï†ïÎ≥¥ -->
                                <div class="mb-1 d-flex flex-wrap gap-1 align-items-center">

                                    <!-- üî• Í≥µÍ≥† Ï∂úÏ≤ò ÏÇ¨Ïù¥Ìä∏ -->
                                    <span class="badge {{ post.source_badge_class }}">
                                        {{ post.source.name }}
                                    </span>



                                    {% if post.post_date %}
                                        <span class="badge bg-light text-dark border">
                                            {{ post.post_date|cut:"Îì±Î°ùÏùº"|cut:"Î™®ÏßëÍ∏∞Í∞Ñ" }}
                                        </span>
                                    {% endif %}

                                    {% if post.school_name %}
                                        <span class="ms-1">
                                            <i class="bi bi-building"></i>
                                            {{ post.school_name }}
                                        </span>
                                    {% endif %}

                                    {% if post.is_new_today %}
                                        <span class="badge bg-danger ms-1">NEW</span>
                                    {% endif %}
                                </div>

                                <!-- üîπ Ïã§Ï†ú Ï†úÎ™© -->
                                <div class="fw-bold ps-1" style="font-size: 0.95rem;">
                                    {{ post.highlighted_title|safe }}
                                </div>




                            </td>

                            <td data-label="ÌååÏùº" class="text-center">
                                {% if post.attachment_urls %}
                                    {% for f in post.attachment_urls %}
                                        <a href="{{ f.url }}"
                                        target="_blank"
                                        class="btn btn-sm btn-outline-success">
                                            Îã§Ïö¥
                                        </a>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>

                            <td data-label="ÎßÅÌÅ¨" class="text-center">
                                <a href="{{ post.link }}"
                                target="_blank"
                                class="btn btn-sm btn-primary">
                                    Î∞îÎ°úÍ∞ÄÍ∏∞
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>



    {% else %}

    <form method="get" id="filterForm" class="mb-3">

            <!-- ÏßÄÏó≠ Ïú†ÏßÄ -->
            <input type="hidden" name="area" value="{{ area }}">

            <div class="row g-2 mb-2">
                <!-- ÏÇ¨Ïù¥Ìä∏ -->
                <div class="col-md-3">
                    <select name="source" class="form-select form-select-sm auto-submit">
                        <option value="">Ï†ÑÏ≤¥ ÏÇ¨Ïù¥Ìä∏</option>
                        {% for s in sources %}
                        <option value="{{ s.id }}"
                            {% if selected.source == s.id|stringformat:"s" %}selected{% endif %}>
                            {{ s.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ÌïôÍµêÎ™Ö Í≤ÄÏÉâ -->
                <div class="col-md-3">
                    <input type="text"
                        name="school"
                        class="form-control form-control-sm auto-submit"
                        placeholder="ÌïôÍµêÎ™Ö Í≤ÄÏÉâ"
                        value="{{ selected.school }}">
                </div>

                
            </div>

            <!-- üî• Î∂ÄÏÑú ÎùºÎîîÏò§ -->
            <div class="d-flex flex-wrap gap-2">
                <!-- Ï†ÑÏ≤¥ -->
                <label class="dept-radio dept-all">
                    <input type="radio"
                        name="department"
                        value=""
                        class="auto-submit"
                        {% if not selected.department %}checked{% endif %}>
                    <span class="dept-label">Ï†ÑÏ≤¥</span>
                </label>

                {% for dep in departments %}
                <label class="dept-radio dept-{{ dep }}">
                    <input type="radio"
                        name="department"
                        value="{{ dep }}"
                        class="auto-submit"
                        {% if selected.department == dep %}checked{% endif %}>
                    <span class="dept-label">{{ dep }}</span>
                </label>
                {% endfor %}
            </div>

        </form>

    <!-- üè´ ÌïôÍµê Í∑∏Î£π -->
    {% for group in groups %}
    {% with group.posts.0 as first %}
    <div class="card mb-3">

        <!-- Ìó§Îçî -->
        <div class="card-header bg-light school-toggle"
             role="button"
             data-target="school-{{ forloop.counter }}">

            <div class="d-flex flex-wrap align-items-center gap-2">

                <span class="badge bg-secondary">
                    {{ first.region|default:"ÏßÄÏó≠ ÏóÜÏùå" }}
                </span>

                {% with first.auto_status as st %}
                    {% if st == "ÎßàÍ∞êÏûÑÎ∞ï" %}
                        <span class="badge bg-danger">ÎßàÍ∞êÏûÑÎ∞ï</span>
                    {% elif st == "Î™®ÏßëÏ§ë" %}
                        <span class="badge bg-success">Î™®ÏßëÏ§ë</span>
                    {% elif st == "ÏòàÏ†ï" %}
                        <span class="badge bg-info">Î™®ÏßëÏòàÏ†ï</span>
                    {% elif st == "ÎßàÍ∞ê" %}
                        <span class="badge bg-secondary">Î™®ÏßëÎßàÍ∞ê</span>
                    {% endif %}
                {% endwith %}

                <span class="badge bg-light text-dark border">

                    {{ first.post_date|cut:"Îì±Î°ùÏùº"|cut:"Î™®ÏßëÍ∏∞Í∞Ñ" }}
                </span>


                <span class="fw-bold">
                    <i class="bi bi-building"></i>
                    {{ group.school }}
                </span>

                <span class="small text-secondary">
                    {{ group.student_count }}
                </span>

                <span>
                    {% if group.has_new %}
                        <span class="badge bg-danger ms-2">NEW</span>
                    {% endif %}
                </span>

                

                <span class="badge bg-dark ms-auto">
                    {{ group.posts|length }}Í±¥
                </span>
            </div>
        </div>

        <!-- üîª Ï†ëÌûò ÏòÅÏó≠ -->
        <div id="school-{{ forloop.counter }}"
             class="school-body"
             style="display:none;">

            <table class="table table-hover table-stack mb-0 align-middle">
                <colgroup>
                    <col style="width:55%">
                    <col style="width:15%">
                    <col style="width:15%">
                    <col style="width:15%">
                </colgroup>
                <thead>
                    <tr>
                        <th class="text-start">Ï†úÎ™©</th>
                        <th class="text-center" style="width:140px;">ÏöîÏùº</th>
                        <th class="text-center" style="width:120px;">ÌååÏùº</th>
                        <th class="text-center" style="width:100px;">ÎßÅÌÅ¨</th>
                    </tr>
                </thead>
                <tbody>
                    {% for post in group.posts %}
                    <tr>
                        <td data-label="Ï†úÎ™©">
                            {% if post.is_new_today %}
                                <span class="badge bg-danger me-1">NEW</span>
                            {% endif %}
                            {{ post.highlighted_title|safe }}
                            {% if post.is_our_program %}
                                <span class="badge bg-success me-1">
                                    <i class="bi bi-person-check-fill"></i> Î©îÏù¥ÌÇπ
                                </span>
                            {% endif %}

                            
                        </td>


                        <td data-label="ÏöîÏùº" class="text-center weekday-cell">
                            <div class="weekday-badges">
                                {{ post.weekday_badges|safe }}
                            </div>
                        </td>


                        <td data-label="Í≥µÍ≥†ÌååÏùº" class="text-center">
                            {% if "ÎäòÎ¥Ñ" in post.source.name %}
                                {% if post.attachment_urls %}
                                    <div class="d-flex justify-content-center gap-2">
                                        {% for f in post.attachment_urls %}
                                        <a href="{{ f.url }}"
                                        target="_blank"
                                        class="btn btn-sm btn-outline-success file-btn">
                                            <i class="bi bi-file-earmark-arrow-down"></i> Îã§Ïö¥
                                        </a>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-muted small">Ï≤®Î∂ÄÌååÏùº ÏóÜÏùå</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>


                        <td data-label="ÎßÅÌÅ¨" class="text-center">
                            <a href="{{ post.link }}"
                            target="_blank"
                            class="btn btn-sm btn-primary link-btn">
                                Î∞îÎ°úÍ∞ÄÍ∏∞
                            </a>
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>
    </div>
    {% endwith %}
    {% empty %}
    <div class="text-center text-muted py-5">
        Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå
    </div>
    {% endfor %}
    {% endif %}
    <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò -->
    <nav class="mt-4">
        <ul class="pagination pagination-sm justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">
                    Ïù¥Ï†Ñ
                </a>
            </li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">
                    {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                </span>
            </li>

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">
                    Îã§Ïùå
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    // ÌïôÍµê Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞
    document.querySelectorAll(".school-toggle").forEach(header => {
        header.addEventListener("click", () => {
            const body = document.getElementById(header.dataset.target);
            if (!body) return;
            body.style.display = body.style.display === "none" ? "block" : "none";
        });
    });

    const form = document.getElementById("filterForm");
    if (!form) return;

    let typingTimer;
    const TYPING_DELAY = 400;

    // ‚úÖ input (ÌïôÍµêÎ™Ö) ‚Üí ÌÉÄÏù¥Ìïë Î©àÏ∂îÎ©¥ ÏûêÎèô submit
    form.querySelectorAll("input.auto-submit").forEach(input => {
        input.addEventListener("input", () => {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                resetPage();
                form.submit();
            }, TYPING_DELAY);
        });
    });

    // ‚úÖ select / radio ‚Üí Ï¶âÏãú submit
    form.querySelectorAll("select.auto-submit, input[type=radio].auto-submit").forEach(el => {
        el.addEventListener("change", () => {
            resetPage();
            form.submit();
        });
    });

    function resetPage() {
        const url = new URL(window.location);
        url.searchParams.delete("page");
        window.history.replaceState({}, "", url);
    }
});
</script>

<script>
function openCutoffEditor() {
    const input = document.getElementById("cutoff-input");
    const label = document.getElementById("cutoff-label");

    label.classList.add("d-none");
    input.classList.remove("d-none");
    input.focus();
}

function saveCutoffDate(value) {
    if (!value) return;

    fetch("{% url 'linkhub:neulbom_cutoff_update' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ cutoff_date: value })
    })
    .then(res => res.json())
    .then(data => {
        if (data.ok) {
            document.getElementById("cutoff-label").innerText =
                "ÏàòÏßë Í∏∞Ï§ÄÏùº: " + data.cutoff_date;

            document.getElementById("cutoff-label").classList.remove("d-none");
            document.getElementById("cutoff-input").classList.add("d-none");
        } else {
            alert("Ï†ÄÏû• Ïã§Ìå®");
        }
    });
}
</script>


{% endblock %}
