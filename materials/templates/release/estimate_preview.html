<!-- === íŒŒì¼: templates/release/estimate_preview.html === -->
<!-- ğŸ‘‰ ê²¬ì ì„œ ë¯¸ë¦¬ë³´ê¸° (êµêµ¬ì¬ í¬í•¨/ì œì™¸ ì„ íƒ + ì œëª©/ë¹„ê³  ìˆ˜ì • + ì¦‰ì‹œ í•©ê³„ ë¯¸ë¦¬ë³´ê¸°) -->

{% extends "base.html" %}
{% load humanize mul_filters %}
{% block content %}
<div class="container mt-4" style="max-width:960px;">
  <div class="card shadow-sm border-0 rounded-3">
    <div class="card-header fw-semibold">
      <i class="bi bi-file-earmark-text"></i> ê²¬ì ì„œ ë¯¸ë¦¬ë³´ê¸°
    </div>

    <div class="card-body">
      <!-- ì•Œë¦¼ -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- ìƒë‹¨ ìš”ì•½ -->
      <p class="mb-2">
        <strong><i class="bi bi-building"></i> ê¸°ê´€:</strong> {{ totals.institution.name }} /
        <strong><i class="bi bi-calendar"></i> ì£¼ë¬¸ë…„ì›”:</strong> {{ totals.order_month }} /
        <strong><i class="bi bi-cash-coin"></i> í•©ê³„:</strong> {{ totals.grand_total|intcomma }}ì›
      </p>
      <p class="mb-3">
        <strong><i class="bi bi-envelope"></i> ìˆ˜ì‹  ì˜ˆì •:</strong>
        {% if recipients and recipients|length > 0 %}
          {{ recipients|join:", " }}
        {% else %}
          <span class="text-warning">ë‹´ë‹¹ì/í–‰ì •ì‹¤ ì´ë©”ì¼ì´ ì—†ì–´ ë°œì†¡ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</span>
        {% endif %}
      </p>

      <!-- âœ… ìˆ˜ì •/ì €ì¥ í¼ ì‹œì‘ -->
      <form method="post" id="estimateForm" class="mb-3">
        {% csrf_token %}
        {{ form.management_form }}
        {{ formset.management_form }}

        <!-- ê²¬ì ì„œ ì •ë³´ -->
        <div class="card mb-3 shadow-sm border-0">
          <div class="card-body">
            <h5 class="mb-3"><i class="bi bi-pencil-square"></i> ê²¬ì ì„œ ì •ë³´</h5>
            <div class="row g-3">
              <div class="col-md-8">
                <label class="form-label">ê²¬ì ì„œ ì œëª©</label>
                {{ form.title }}
              </div>
              <div class="col-12">
                <label class="form-label">ë¹„ê³ /íŠ¹ì´ì‚¬í•­</label>
                {{ form.notes }}
              </div>
            </div>
          </div>
        </div>

        <!-- êµêµ¬ì¬ ì„ íƒ -->
        <div class="card mb-3 shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0"><i class="bi bi-box-seam"></i> êµêµ¬ì¬ ì„ íƒ</h5>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="checkAll">
                  <i class="bi bi-check2-square"></i> ì „ì²´ ì„ íƒ
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="uncheckAll">
                  <i class="bi bi-square"></i> ì „ì²´ í•´ì œ
                </button>
              </div>
            </div>

            <table class="table table-bordered align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th style="width: 6%;">í¬í•¨</th>
                  <th style="width: 30%;">êµêµ¬ì¬ëª…</th>
                  <th style="width: 30%;">ê·¸ë£¹ëª…</th>
                  <th style="width: 10%;">ë‹¨ê°€(ì›)</th>
                  <th style="width: 8%;">ìˆ˜ëŸ‰</th>
                  <th style="width: 16%;">ì†Œê³„(ì›)</th>
                </tr>
              </thead>
              <tbody id="itemTbody">
              {% for f in formset %}
                {% with it=f.instance %}
                <tr data-unit="{{ it.unit_price }}" data-qty="{{ it.quantity }}">
                  <td>
                    {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}
                    {{ f.included }}
                  </td>
                  <td class="text-center">
                    <div class="fs-6">{{ it.material.name }}</div>
                  </td>
                  <td>
                    <span class="group-name-display text-muted small">
                      {{ f.group_name.value|default:it.material.name }}
                    </span>
                    <button type="button" class="btn btn-sm btn-outline-secondary edit-group-btn">ìˆ˜ì •</button>
                    <div class="group-name-edit d-none mt-1">
                      {{ f.group_name }}
                      <button type="button" class="btn btn-sm btn-primary save-group-btn">ì €ì¥</button>
                    </div>
                  </td>
                  <td>{{ it.unit_price|intcomma }}</td>
                  <td>{{ it.quantity|intcomma }}</td>
                  <td class="line-total text-end">{{ it.unit_price|mul:it.quantity|intcomma }}</td>
                </tr>
                {% endwith %}
              {% endfor %}
              </tbody>
            </table>

            <small class="text-muted">â€» ë‹¨ê°€ëŠ” VAT í¬í•¨ê°€ë¡œ ê°€ì •í•©ë‹ˆë‹¤.</small>
          </div>
        </div>

        <!-- í•©ê³„ -->
        <div class="card mb-3 shadow-sm border-0">
          <div class="card-body">
            <h5 class="mb-3"><i class="bi bi-calculator"></i> í•©ê³„ (ì„ íƒ ë°˜ì˜ ë¯¸ë¦¬ë³´ê¸°)</h5>
            <div class="row g-3">
              <div class="col-md-4">
                <div class="p-3 bg-light rounded-3">
                  <div class="small text-muted">ê³µê¸‰ê°€ì•¡</div>
                  <div class="fs-5 fw-semibold" id="supplySum">-</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="p-3 bg-light rounded-3">
                  <div class="small text-muted">ë¶€ê°€ì„¸</div>
                  <div class="fs-5 fw-semibold" id="vatSum">-</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="p-3 bg-light rounded-3">
                  <div class="small text-muted">ì´ í•©ê³„(VAT í¬í•¨)</div>
                  <div class="fs-5 fw-semibold" id="totalSum">-</div>
                </div>
              </div>
            </div>
            <div class="small text-muted mt-2">
              * ë¯¸ë¦¬ë³´ê¸° ê°’ì€ ì²´í¬ ìƒíƒœë¡œ ê³„ì‚°í•œ ê°’ì´ë©°, <strong>ì €ì¥</strong> í›„ PDF/ë©”ì¼ì— ë°˜ì˜ë©ë‹ˆë‹¤. (VAT ê³„ì‚°: ì´ì•¡ Ã· 11, 5 ì´ìƒ ë°˜ì˜¬ë¦¼)
            </div>
          </div>
        </div>
      </form>
      <!-- âœ… ì €ì¥í¼ ë -->

      <!-- ë²„íŠ¼ ê·¸ë£¹ (4ê°œ í•œ ì¤„) -->
      <div class="d-flex gap-2 flex-wrap">
        <!-- ì €ì¥ -->
        <button type="submit" form="estimateForm" class="btn btn-primary">
          <i class="bi bi-save"></i> ì €ì¥
        </button>

        <!-- PDF ë¯¸ë¦¬ë³´ê¸° -->
        <a href="{{ pdf_url }}" target="_blank" class="btn btn-outline-primary">
          <i class="bi bi-filetype-pdf"></i> PDF ë¯¸ë¦¬ë³´ê¸°
        </a>

        <!-- ì´ë©”ì¼ ë°œì†¡ -->
        <form method="post" action="{{ send_url }}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-success">
            <i class="bi bi-send"></i> ì´ë©”ì¼ ë°œì†¡
          </button>
        </form>

        <!-- ëª©ë¡ìœ¼ë¡œ -->
        <a href="{% url 'release_list' %}?teacher={{ selected_teacher_id|default_if_none:'' }}&institution={{ selected_institution_id|default_if_none:'' }}&order_month={{ selected_order_month|default_if_none:'' }}" class="btn btn-secondary">
          <i class="bi bi-list-ul"></i> ëª©ë¡ìœ¼ë¡œ
        </a>
      </div>
    </div>
  </div>
</div>

<!-- í•©ê³„ ê³„ì‚° JS -->
<script>
  function nfmt(n){ return (n||0).toLocaleString(); }
  function calcVatFromTotal(total){ return Math.floor((total + 5) / 11); }

  function recalc(){
    const rows = document.querySelectorAll('#itemTbody tr');
    let total = 0;
    rows.forEach(row => {
      const cb = row.querySelector('input[type="checkbox"]');
      if(cb && cb.checked){
        const u = parseInt(row.dataset.unit || '0', 10);
        const q = parseInt(row.dataset.qty  || '0', 10);
        total += (u * q);
      }
    });
    const vat = calcVatFromTotal(total);
    const supply = total - vat;

    document.getElementById('totalSum').textContent  = nfmt(total) + 'ì›';
    document.getElementById('vatSum').textContent    = nfmt(vat)   + 'ì›';
    document.getElementById('supplySum').textContent = nfmt(supply)+ 'ì›';
  }

  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('#itemTbody input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', recalc);
    });
    document.getElementById('checkAll').addEventListener('click', () => {
      document.querySelectorAll('#itemTbody input[type="checkbox"]').forEach(cb => cb.checked = true);
      recalc();
    });
    document.getElementById('uncheckAll').addEventListener('click', () => {
      document.querySelectorAll('#itemTbody input[type="checkbox"]').forEach(cb => cb.checked = false);
      recalc();
    });
    recalc();
  });

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".edit-group-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const td = btn.closest("td");
        td.querySelector(".group-name-display").classList.add("d-none");
        td.querySelector(".edit-group-btn").classList.add("d-none");
        td.querySelector(".group-name-edit").classList.remove("d-none");
      });
    });

    document.querySelectorAll(".save-group-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const td = btn.closest("td");
        const input = td.querySelector("input[name$='group_name']");
        const display = td.querySelector(".group-name-display");
        display.textContent = input.value || "-";

        td.querySelector(".group-name-display").classList.remove("d-none");
        td.querySelector(".edit-group-btn").classList.remove("d-none");
        td.querySelector(".group-name-edit").classList.add("d-none");
      });
    });
  });
</script>
{% endblock %}
