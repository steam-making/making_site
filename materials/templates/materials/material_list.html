{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<div class="container mt-4">
  <div class="card p-4 shadow-sm">
    <h3 class="mb-4 text-center">ğŸ“¦ êµêµ¬ì¬ ëª©ë¡</h3>

    <!-- í•„í„° -->
    <form method="get" class="row g-2 align-items-center mb-4">
      <div class="col-auto">
        <label for="vendor" class="col-form-label fw-bold">ê±°ë˜ì²˜:</label>
      </div>
      <div class="col-auto">
        <select name="vendor" id="vendor" class="form-select" onchange="this.form.submit()">
          <option value="">ì „ì²´</option>
          {% for vendor in vendors %}
            <option value="{{ vendor.id }}" {% if vendor.id|stringformat:"s" == selected_vendor_id %}selected{% endif %}>
              {{ vendor.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <input type="text" name="q" class="form-control" placeholder="êµêµ¬ì¬ëª… ë˜ëŠ” ê±°ë˜ì²˜ëª… ê²€ìƒ‰" value="{{ search_query }}">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">ğŸ” ê²€ìƒ‰</button>
      </div>
    </form>

    <!-- ìƒë‹¨ ë²„íŠ¼ -->
    <div class="mb-3 d-flex flex-wrap gap-2 justify-content-between align-items-center">
      <div>
         <a href="{% url 'material_create' %}?next={{ request.get_full_path }}" 
          class="btn btn-primary">
          <i class="bi bi-plus-circle me-1"></i> êµêµ¬ì¬ ë“±ë¡
        </a>
        <a href="{% url 'material_bulk_upload' %}" class="btn btn-secondary">ğŸ“ ì—‘ì…€ ë“±ë¡</a>
        <a href="{% url 'download_material_template' %}" class="btn btn-outline-info">ğŸ“„ ì—‘ì…€ í…œí”Œë¦¿</a>
        <a href="{% url 'vendor_create' %}" class="btn btn-outline-secondary">ğŸ· ê±°ë˜ì²˜ ë“±ë¡</a>
        <a href="{% url 'vendor_list' %}" class="btn btn-outline-secondary">ğŸ“‹ ê±°ë˜ì²˜ ëª©ë¡</a>
        
      </div>
      <div>
      <!-- âœ… ìˆœì„œë³€ê²½/ìˆœì„œì €ì¥ í† ê¸€ ë²„íŠ¼ -->
      <button id="toggleOrderBtn" class="btn btn-outline-primary">
        ğŸ”„ ìˆœì„œë³€ê²½
      </button>
  </div>
    </div>

    <!-- ê±°ë˜ì²˜ë³„ í‘œ -->
    {% regroup materials by vendor as vendor_list %}
    {% for group in vendor_list %}
    <h5 class="mt-4">ğŸ· {{ group.grouper.name }}</h5>
    <form id="materialDeleteForm_{{ group.grouper.id }}" action="{% url 'material_bulk_delete' %}" method="post">
      {% csrf_token %}
      <div class="table-responsive">
        <table class="table table-bordered table-hover text-center align-middle">
          <thead class="table-light">
            <tr>
              <th><input type="checkbox" class="selectAll" data-vendor="{{ group.grouper.id }}"></th>
              <th>êµêµ¬ì¬ëª…</th>
              <th>ì†Œë¹„ìê°€</th>
              <th>í•™êµë‚©í’ˆê°€</th>
              <th>ê¸°ê´€ë‚©í’ˆê°€</th>
              <th>ê³µê¸‰ê°€</th>
              <th>ì¬ê³ </th>
              <th colspan="3">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody class="sortable" data-vendor="{{ group.grouper.id }}">
            {% for material in group.list %}
            <tr data-id="{{ material.id }}">
              <td><input type="checkbox" name="material_ids" value="{{ material.pk }}" class="material-checkbox" data-vendor="{{ group.grouper.id }}"></td>
              <td>{{ material.name }}</td>
              <td>{{ material.consumer_price|intcomma }}ì›</td>
              <td>{{ material.school_price|intcomma }}ì›</td>
              <td>{{ material.institute_price|intcomma }}ì›</td>
              <td>{{ material.supply_price|intcomma }}ì›</td>
              <td>{{ material.stock }}</td>
              <td>
                  <a href="{% url 'material_edit' material.pk %}?next={{ request.get_full_path }}"
                    class="btn btn-sm btn-warning">
                      <i class="bi bi-pencil-square"></i> ìˆ˜ì •
                  </a>
              </td>
              <td>
                <button type="submit"
                        formaction="{% url 'material_delete' material.pk %}?next={{ request.get_full_path }}"
                        class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <i class="bi bi-trash"></i> ì‚­ì œ
                </button>

              </td>
              <td>
                {% if material.pk %}
                <a href="{% url 'material_history' material.pk %}" class="btn btn-sm btn-outline-info">
                  <i class="bi bi-clock-history"></i> ì´ë ¥
                </a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
    {% endfor %}
  </div>
</div>

<!-- === í•˜ë‹¨ JS === -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const toggleBtn = document.getElementById("toggleOrderBtn");
  let orderingMode = false;   // í˜„ì¬ ìˆœì„œë³€ê²½ ëª¨ë“œ ì—¬ë¶€
  let sortables = [];         // Sortable ì¸ìŠ¤í„´ìŠ¤ ë³´ê´€
  let currentOrder = {};      // ìˆœì„œ ì €ì¥ìš©

  // ê° í…Œì´ë¸” tbodyì— Sortable ì´ˆê¸°í™” (ì²˜ìŒì—ëŠ” disabled)
  document.querySelectorAll(".sortable").forEach(function(tbody) {
    const sortable = new Sortable(tbody, {
      handle: "tr",
      animation: 150,
      disabled: true, // âœ… ê¸°ë³¸ì€ ë¹„í™œì„±í™”
      onEnd: function () {
        const vendorId = tbody.dataset.vendor;
        let order = [];
        tbody.querySelectorAll("tr").forEach((row, index) => {
          order.push({id: row.dataset.id, vendor: vendorId, position: index + 1});
        });
        currentOrder[vendorId] = order;
      }
    });
    sortables.push(sortable);
  });

  // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  toggleBtn.addEventListener("click", function() {
    if (!orderingMode) {
      // === ìˆœì„œë³€ê²½ ëª¨ë“œ ON ===
      orderingMode = true;
      toggleBtn.textContent = "ğŸ’¾ ìˆœì„œì €ì¥";
      sortables.forEach(s => s.option("disabled", false)); // ë“œë˜ê·¸ í™œì„±í™”
      alert("ì´ì œ í–‰ì„ ë“œë˜ê·¸í•´ì„œ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    } else {
      // === ìˆœì„œì €ì¥ ì‹¤í–‰ ===
      orderingMode = false;
      toggleBtn.textContent = "ğŸ”„ ìˆœì„œë³€ê²½";
      sortables.forEach(s => s.option("disabled", true)); // ë“œë˜ê·¸ ë¹„í™œì„±í™”

      // ëª¨ë“  ë²¤ë” ìˆœì„œ í•©ì¹˜ê¸°
      const orders = [];
      for (const vendorId in currentOrder) {
        orders.push(...currentOrder[vendorId]);
      }

      if (orders.length === 0) {
        alert("ë³€ê²½ëœ ìˆœì„œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      fetch("{% url 'reorder_materials' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(orders)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          alert("ìˆœì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          window.location.reload();
        } else {
          alert("ìˆœì„œ ì €ì¥ ì‹¤íŒ¨: " + data.message);
        }
      })
      .catch(err => alert("ì˜¤ë¥˜ ë°œìƒ: " + err));
    }
  });
});
</script>

{% endblock %}
