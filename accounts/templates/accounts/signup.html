{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .form-label { font-weight: 600; }
        .form-text { font-size: 0.9em; }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-7 col-lg-6">
            <div class="card p-4">
                <h3 class="text-center mb-4">회원가입</h3>

                <form method="post">
                    {% csrf_token %}

                    <!-- 이메일 -->
                    <div class="mb-3">
                        <label class="form-label">이메일 (로그인 아이디)</label>
                        <div class="input-group mb-2">
                            <input type="text" id="email_id" class="form-control" placeholder="이메일 아이디">
                            <span class="input-group-text">@</span>
                            <input type="text" id="email_domain" class="form-control" placeholder="도메인 입력">
                        </div>

                        <select id="domain_select" class="form-select mb-2">
                            <option value="">도메인 선택</option>
                            <option value="gmail.com">gmail.com</option>
                            <option value="naver.com">naver.com</option>
                            <option value="daum.net">daum.net</option>
                            <option value="hanmail.net">hanmail.net</option>
                            <option value="직접입력" selected>직접입력</option>
                        </select>
                        <div id="username-check-msg" class="form-text"></div> <!-- ✅ 중복체크 메시지 -->
                    </div>

                    <input type="hidden" id="id_email" name="email">
                    

                    <!-- 비밀번호 -->
                    <div class="mb-3">
                        <label class="form-label">비밀번호</label>
                        {{ form.password1|add_class:"form-control" }}
                        <div class="form-text" id="password-guidance">※ 영문, 숫자, 특수문자를 포함해 8자 이상</div>
                        <div id="password-strength" class="form-text"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">비밀번호 확인</label>
                        {{ form.password2|add_class:"form-control" }}
                        <div id="password-match" class="form-text"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">회원 유형</label>
                        {{ form.user_type|add_class:"form-select" }}
                    </div>

                    <!-- 이름 -->
                    <div class="mb-3">
                        <label class="form-label">이름</label>
                        {{ form.first_name|add_class:"form-control" }}
                        {{ form.first_name.errors }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">생년월일</label>
                        {{ form.birth_date|add_class:"form-control" }}
                    </div>

                    <!-- 전화번호 -->
                    <div class="mb-3">
                        <label class="form-label">전화번호</label>
                        <div class="input-group">
                            <select id="phone_start" class="form-select" style="max-width: 90px;">
                                <option value="010" selected>010</option>
                                <option value="011">011</option>
                                <option value="016">016</option>
                                <option value="017">017</option>
                                <option value="018">018</option>
                                <option value="019">019</option>
                            </select>
                            <input type="text" id="phone_middle" class="form-control" maxlength="4" placeholder="1234">
                            <input type="text" id="phone_end" class="form-control" maxlength="4" placeholder="5678">
                        </div>
                    </div>

                    <input type="hidden" id="id_phone_number" name="phone_number">

                    <!-- ✅ 자녀 정보 입력 영역 -->
                    <div id="children-wrapper" class="mb-3" style="display:none;">
                    <label class="form-label fw-bold">자녀 정보</label>
                    <div id="children-list">
                        <div class="child-item mb-2 d-flex gap-2">
                        <input type="text" name="child_name[]" class="form-control" placeholder="자녀 이름">
                        <input type="date" name="child_birth[]" class="form-control" placeholder="생년월일">
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-child-btn">
                        + 자녀 추가
                    </button>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">우편번호</label>
                        <div class="input-group">
                            {{ form.postcode|add_class:"form-control" }}
                            <button type="button" class="btn btn-secondary" onclick="execDaumPostcode()">주소 찾기</button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">주소</label>
                        {{ form.address|add_class:"form-control" }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">상세주소</label>
                        {{ form.detail_address|add_class:"form-control" }}
                    </div>

                    <button type="submit" class="btn btn-primary w-100">가입하기</button>
                </form>

                <p class="text-center mt-3 text-muted">이미 계정이 있으신가요? <a href="{% url 'login' %}">로그인</a></p>
            </div>
        </div>
    </div>
</div>

<!-- JS 코드 -->
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
function execDaumPostcode() {
    new daum.Postcode({
        oncomplete: function(data) {
            document.getElementById('id_postcode').value = data.zonecode;
            document.getElementById('id_address').value = data.address;
            document.getElementById('id_detail_address').focus();
        }
    }).open();
}

document.getElementById('domain_select').addEventListener('change', function() {
    const domainInput = document.getElementById('email_domain');
    if (this.value === '직접입력') {
        domainInput.value = '';
        domainInput.readOnly = false;
        domainInput.focus();
    } else {
        domainInput.value = this.value;
        domainInput.readOnly = true;
    }
});

document.getElementById('phone_middle').addEventListener('input', onlyNumber);
document.getElementById('phone_end').addEventListener('input', onlyNumber);

function onlyNumber(e) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
}

const pw = document.getElementById('id_password1');
const pw2 = document.getElementById('id_password2');
pw.addEventListener('input', validatePassword);
pw2.addEventListener('input', checkPasswordMatch);

function validatePassword() {
    const password = pw.value;
    const hasLetter = /[a-zA-Z]/.test(password);
    const hasNumber = /\d/.test(password);
    const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);
    const score = (password.length >=8) + hasLetter + hasNumber + hasSpecialChar;
    const strength = ['약함','보통','강함'][Math.max(0,score-2)];
    document.getElementById('password-strength').textContent = '비밀번호 강도: ' + (strength || '약함');

    checkPasswordMatch();
}

function checkPasswordMatch() {
    const msg = document.getElementById('password-match');
    if (pw2.value && pw.value !== pw2.value) {
        msg.textContent = '❌ 비밀번호가 일치하지 않습니다.';
        msg.style.color = 'red';
    } else if (pw2.value) {
        msg.textContent = '✅ 비밀번호가 일치합니다.';
        msg.style.color = 'green';
    } else {
        msg.textContent = '';
    }
}

document.querySelector('form').addEventListener('submit', function(e) {
    const emailId = document.getElementById('email_id').value.trim();
    const emailDomain = document.getElementById('email_domain').value.trim();
    if (!emailId || !emailDomain) {
        e.preventDefault();
        alert('이메일 아이디와 도메인을 입력하세요.');
        return;
    }
    document.getElementById('id_email').value = `${emailId}@${emailDomain}`;

    const phone = `${document.getElementById('phone_start').value}-${document.getElementById('phone_middle').value}-${document.getElementById('phone_end').value}`;
    document.getElementById('id_phone_number').value = phone;
});

// ✅ 아이디(이메일) 중복체크
const emailIdInput = document.getElementById("email_id");
const emailDomainInput = document.getElementById("email_domain");
const usernameMsg = document.getElementById("username-check-msg");

function checkUsernameDuplicate() {
    const emailId = emailIdInput.value.trim();
    const emailDomain = emailDomainInput.value.trim();
    if (!emailId || !emailDomain) {
        usernameMsg.textContent = "";
        return;
    }
    const username = `${emailId}@${emailDomain}`;
    fetch(`/accounts/check-username/?username=${encodeURIComponent(username)}`)
        .then(res => res.json())
        .then(data => {
            if (data.exists) {
                usernameMsg.textContent = "❌ 이미 사용 중인 아이디입니다.";
                usernameMsg.style.color = "red";
            } else {
                usernameMsg.textContent = "✅ 사용 가능한 아이디입니다.";
                usernameMsg.style.color = "green";
            }
        });
}

emailIdInput.addEventListener("blur", checkUsernameDuplicate);
emailDomainInput.addEventListener("blur", checkUsernameDuplicate);

// ✅ 회원 유형 선택 시 자녀정보 보이기
const userTypeSelect = document.getElementById("id_user_type");
const childrenWrapper = document.getElementById("children-wrapper");
const addChildBtn = document.getElementById("add-child-btn");
const childrenList = document.getElementById("children-list");

function toggleChildrenFields() {
    if (userTypeSelect.value === "parent") { // 학부모일 경우
        childrenWrapper.style.display = "block";
    } else {
        childrenWrapper.style.display = "none";
        childrenList.innerHTML = `
          <div class="child-item mb-2 d-flex gap-2">
            <input type="text" name="child_name[]" class="form-control" placeholder="자녀 이름">
            <input type="date" name="child_birth[]" class="form-control" placeholder="생년월일">
          </div>
        `;
    }
}

userTypeSelect.addEventListener("change", toggleChildrenFields);
document.addEventListener("DOMContentLoaded", toggleChildrenFields);

// ✅ 자녀 추가 버튼
addChildBtn.addEventListener("click", function() {
    const newChild = document.createElement("div");
    newChild.classList.add("child-item", "mb-2", "d-flex", "gap-2");
    newChild.innerHTML = `
        <input type="text" name="child_name[]" class="form-control" placeholder="자녀 이름">
        <input type="date" name="child_birth[]" class="form-control" placeholder="생년월일">
        <button type="button" class="btn btn-sm btn-outline-danger remove-child">삭제</button>
    `;
    childrenList.appendChild(newChild);

    // 삭제 버튼 이벤트
    newChild.querySelector(".remove-child").addEventListener("click", function() {
        newChild.remove();
    });
});

</script>
</body>
</html>
