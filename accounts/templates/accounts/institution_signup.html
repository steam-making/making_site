{# templates/accounts/institution_signup.html #}
{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>기관 회원가입</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .form-label { font-weight: 600; }
        .form-text { font-size: 0.9em; }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card p-4">
                <h3 class="text-center mb-4 text-success">
                    <i class="bi bi-building"></i> 기관 회원가입
                </h3>

                <form method="post">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    <!-- 이메일 -->
                    <div class="mb-3">
                        <label class="form-label">기관 이메일 (로그인 아이디)</label>
                        <div class="input-group mb-2">
                            <input type="text" id="email_id" class="form-control" placeholder="이메일 아이디">
                            <span class="input-group-text">@</span>
                            <input type="text" id="email_domain" class="form-control" placeholder="도메인 입력">
                        </div>
                        <select id="domain_select" class="form-select mb-2">
                            <option value="">도메인 선택</option>
                            <option value="gmail.com">gmail.com</option>
                            <option value="naver.com">naver.com</option>
                            <option value="daum.net">daum.net</option>
                            <option value="hanmail.net">hanmail.net</option>
                            <option value="직접입력" selected>직접입력</option>
                        </select>
                        <div id="username-check-msg" class="form-text"></div>
                    </div>
                    <input type="hidden" id="id_email" name="email">

                    <!-- 비밀번호 -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-lock"></i> 비밀번호</label>
                        {{ form.password1|add_class:"form-control" }}
                        <div class="form-text" id="password-guidance">※ 영문, 숫자, 특수문자를 포함해 8자 이상</div>
                        <div id="password-strength" class="form-text"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-lock-fill"></i> 비밀번호 확인</label>
                        {{ form.password2|add_class:"form-control" }}
                        <div id="password-match" class="form-text"></div>
                    </div>

                    <!-- 기관 기본 -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-building-gear"></i> 기관명</label>
                        {{ form.institution_name|add_class:"form-control" }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-upc-scan"></i> 사업자등록번호</label>
                        {{ form.business_number|add_class:"form-control" }}
                    </div>

                    <!-- 기관 전화번호 -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-telephone"></i> 기관 전화번호</label>
                        <div class="input-group">
                            <select id="office_area" class="form-select" style="max-width: 100px;">
                                <option value="02">02</option>
                                <option value="031">031</option>
                                <option value="032">032</option>
                                <option value="033">033</option>
                                <option value="041">041</option>
                                <option value="042">042</option>
                                <option value="043">043</option>
                                <option value="051">051</option>
                                <option value="052">052</option>
                                <option value="053">053</option>
                                <option value="054">054</option>
                                <option value="055">055</option>
                                <option value="061">061</option>
                                <option value="062">062</option>
                                <option value="063">063</option>
                                <option value="064">064</option>
                            </select>
                            <input type="text" id="office_mid" class="form-control" maxlength="4">
                            <input type="text" id="office_end" class="form-control" maxlength="4">
                        </div>
                        <input type="hidden" id="id_office_phone" name="office_phone">
                    </div>

                    <!-- 팩스 -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-printer"></i> 팩스</label>
                            {{ form.fax|add_class:"form-control" }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-briefcase"></i> 업종</label>
                            {{ form.industry|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-person-badge"></i> 담당자명</label>
                        {{ form.contact_name|add_class:"form-control" }}
                    </div>

                    <!-- 담당자 전화번호 -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-phone"></i> 담당자 휴대폰 번호</label>
                        <div class="input-group">
                            <select id="phone_start" class="form-select" style="max-width: 90px;">
                                <option value="010" selected>010</option>
                                <option value="011">011</option>
                                <option value="016">016</option>
                                <option value="017">017</option>
                                <option value="018">018</option>
                                <option value="019">019</option>
                            </select>
                            <input type="text" id="phone_middle" class="form-control" maxlength="4" placeholder="1234">
                            <input type="text" id="phone_end" class="form-control" maxlength="4" placeholder="5678">
                        </div>
                        <input type="hidden" id="id_contact_phone" name="contact_phone">
                    </div>

                    <!-- 주소 -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-geo-alt"></i> 우편번호</label>
                        <div class="input-group">
                            {{ form.postcode|add_class:"form-control" }}
                            <button type="button" class="btn btn-secondary" onclick="execDaumPostcode()">주소 찾기</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-house"></i> 주소</label>
                        {{ form.address|add_class:"form-control" }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-signpost-split"></i> 상세주소</label>
                        {{ form.detail_address|add_class:"form-control" }}
                    </div>

                    <!-- 추가 -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-globe"></i> 홈페이지</label>
                        {{ form.website|add_class:"form-control" }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-journal-text"></i> 비고</label>
                        {{ form.note|add_class:"form-control" }}
                    </div>

                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check-circle"></i> 가입 신청
                    </button>
                </form>

                <p class="text-center mt-3 text-muted">
                    이미 계정이 있으신가요? <a href="{% url 'login' %}"><i class="bi bi-box-arrow-in-right"></i> 로그인</a>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Daum 주소 API -->
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
// ✅ 아이디(이메일) 중복체크
const emailIdInput = document.getElementById("email_id");
const emailDomainInput = document.getElementById("email_domain");
const usernameMsg = document.getElementById("username-check-msg");

function checkUsernameDuplicate() {
    const emailId = emailIdInput.value.trim();
    const emailDomain = emailDomainInput.value.trim();
    if (!emailId || !emailDomain) {
        usernameMsg.textContent = "";
        return;
    }
    const username = `${emailId}@${emailDomain}`;
    fetch(`/accounts/check-username/?username=${encodeURIComponent(username)}`)
        .then(res => res.json())
        .then(data => {
            if (data.exists) {
                usernameMsg.textContent = "❌ 이미 사용 중인 아이디입니다.";
                usernameMsg.style.color = "red";
            } else {
                usernameMsg.textContent = "✅ 사용 가능한 아이디입니다.";
                usernameMsg.style.color = "green";
            }
        });
}
emailIdInput.addEventListener("blur", checkUsernameDuplicate);
emailDomainInput.addEventListener("blur", checkUsernameDuplicate);

// ✅ 도메인 선택
document.getElementById('domain_select').addEventListener('change', function() {
    const domainInput = document.getElementById('email_domain');
    if (this.value === '직접입력') {
        domainInput.value = '';
        domainInput.readOnly = false;
        domainInput.focus();
    } else {
        domainInput.value = this.value;
        domainInput.readOnly = true;
    }
});

// ✅ 비밀번호 강도/일치 체크
const pw = document.getElementById('id_password1');
const pw2 = document.getElementById('id_password2');

pw.addEventListener('input', validatePassword);
pw2.addEventListener('input', checkPasswordMatch);

function validatePassword() {
    const password = pw.value;
    const hasLetter = /[a-zA-Z]/.test(password);
    const hasNumber = /\d/.test(password);
    const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);
    const score = (password.length >= 8) + hasLetter + hasNumber + hasSpecialChar;
    const strength = ['약함','보통','강함'][Math.max(0, score - 2)];
    document.getElementById('password-strength').textContent =
        '비밀번호 강도: ' + (strength || '약함');
    checkPasswordMatch();
}

function checkPasswordMatch() {
    const msg = document.getElementById('password-match');
    if (pw2.value && pw.value !== pw2.value) {
        msg.textContent = '❌ 비밀번호가 일치하지 않습니다.';
        msg.style.color = 'red';
    } else if (pw2.value) {
        msg.textContent = '✅ 비밀번호가 일치합니다.';
        msg.style.color = 'green';
    } else {
        msg.textContent = '';
    }
}

// ✅ Daum 주소 API
function execDaumPostcode() {
    new daum.Postcode({
        oncomplete: function(data) {
            document.getElementById('id_postcode').value = data.zonecode;
            document.getElementById('id_address').value = data.address;
            document.getElementById('id_detail_address').focus();
        }
    }).open();
}

// ✅ 숫자만 입력
function onlyNumber(e) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
}
document.getElementById('office_mid').addEventListener('input', onlyNumber);
document.getElementById('office_end').addEventListener('input', onlyNumber);
document.getElementById('phone_middle').addEventListener('input', onlyNumber);
document.getElementById('phone_end').addEventListener('input', onlyNumber);

// ✅ 최종 form 제출 이벤트
document.querySelector('form').addEventListener('submit', function(e) {
    // 이메일 합치기
    const emailId = document.getElementById('email_id').value.trim();
    const emailDomain = document.getElementById('email_domain').value.trim();
    if (!emailId || !emailDomain) {
        e.preventDefault();
        alert('이메일 아이디와 도메인을 입력하세요.');
        return;
    }
    document.getElementById('id_email').value = `${emailId}@${emailDomain}`;

    // 기관 전화번호 합치기
    const office = `${document.getElementById('office_area').value}-${document.getElementById('office_mid').value}-${document.getElementById('office_end').value}`;
    document.getElementById('id_office_phone').value = office;

    // 담당자 휴대폰 합치기
    const phone = `${document.getElementById('phone_start').value}-${document.getElementById('phone_middle').value}-${document.getElementById('phone_end').value}`;
    document.getElementById('id_contact_phone').value = phone; // ✅ contact_phone 으로 맞춤
});
</script>

</body>
</html>
