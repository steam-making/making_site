{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-body">

      <!-- ì œëª© (1ì¤„, ê°€ìš´ë°) -->
      <div class="text-center mb-3">
        <h4 class="mb-0">
          <i class="bi bi-people-fill me-2"></i>íšŒì› ëª©ë¡ (ê´€ë¦¬ì ì „ìš©)
        </h4>
      </div>

      <!-- 2ì¤„ : íšŒì›ìœ í˜• + ê²€ìƒ‰ + ì •ë ¬ -->
      <form id="filterForm" method="get" class="mb-4">
        <div class="row align-items-center g-2">

          <!-- íšŒì›ìœ í˜• -->
          <!-- íšŒì›ìœ í˜• (ê°œí–‰/ì„¸ë¡œ ë°©ì§€ ì™„ì „ í•´ê²° ë²„ì „) -->
          <div class="col-12 col-lg-6">
            <div class="d-flex align-items-center gap-2 flex-nowrap overflow-auto">

              <span class="fw-semibold text-nowrap me-2">
                <i class="bi bi-person-badge me-1"></i>íšŒì›ìœ í˜•
              </span>

              <!-- ì „ì²´ -->
              <label class="d-inline-flex align-items-center gap-1 text-nowrap mb-0">
                <input type="radio"
                      name="user_type"
                      value=""
                      {% if not user_type %}checked{% endif %}>
                <span>ì „ì²´</span>
              </label>

              {% for val,label in USER_TYPE_CHOICES %}
              <label class="d-inline-flex align-items-center gap-1 text-nowrap mb-0">
                <input type="radio"
                      name="user_type"
                      value="{{ val }}"
                      {% if user_type == val %}checked{% endif %}>
                <span>{{ label }}</span>
              </label>
              {% endfor %}

            </div>
          </div>



          <!-- ê²€ìƒ‰ + ì •ë ¬ -->
          <div class="col-12 col-lg-6">
            <div class="d-flex justify-content-lg-end justify-content-start gap-2 flex-wrap">

              <!-- ê²€ìƒ‰ -->
              <div class="input-group input-group-sm" style="width: 200px;">
                <span class="input-group-text">
                  <i class="bi bi-search"></i>
                </span>
                <input type="text"
                      name="q"
                      value="{{ q }}"
                      class="form-control"
                      placeholder="ì´ë¦„ / ì•„ì´ë””">
              </div>

              <!-- ì •ë ¬ -->
              <div class="input-group input-group-sm" style="width: 160px;">
                <span class="input-group-text">
                  <i class="bi bi-sort-down"></i>
                </span>
                <select name="order" class="form-select">
                  <option value="-date_joined" {% if order == '-date_joined' %}selected{% endif %}>ìµœê·¼ê°€ì…</option>
                  <option value="date_joined" {% if order == 'date_joined' %}selected{% endif %}>ì˜¤ë˜ëœê°€ì…</option>
                  <option value="username" {% if order == 'username' %}selected{% endif %}>ì•„ì´ë”” â†‘</option>
                  <option value="-username" {% if order == '-username' %}selected{% endif %}>ì•„ì´ë”” â†“</option>
                  <option value="first_name" {% if order == 'first_name' %}selected{% endif %}>ì´ë¦„ â†‘</option>
                  <option value="-first_name" {% if order == '-first_name' %}selected{% endif %}>ì´ë¦„ â†“</option>
                </select>
              </div>

              <!-- ê²€ìƒ‰ + ì •ë ¬ + ê´€ë¦¬ì ì•¡ì…˜ -->
              <div class="d-flex justify-content-end gap-2 flex-wrap">

                <!-- íšŒì› ì¶”ê°€ -->
                <button type="button"
                        class="btn btn-sm btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#bulkUserModal">
                  <i class="bi bi-person-plus"></i> íšŒì› ì¶”ê°€
                </button>


              </div>

            </div>
          </div>

        </div>
      </form>

      <!-- ì—¬ëŸ¬ ëª… íšŒì› ì¶”ê°€ ëª¨ë‹¬ -->
            <div class="modal fade" id="bulkUserModal" tabindex="-1">
              <div class="modal-dialog modal-xl">
                <form method="post" action="{% url 'admin_user_bulk_create' %}">
                  {% csrf_token %}
                  <div class="modal-content">

                    <div class="modal-header">
                      <h5 class="modal-title">
                        <i class="bi bi-people-plus"></i> íšŒì› ì—¬ëŸ¬ ëª… ì¶”ê°€
                      </h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">

                      <table class="table table-sm align-middle">
                        <thead>
                          <tr>
                            <th>ì´ë©”ì¼(ID)</th>
                            <th>ì´ë¦„</th>
                            <th>íšŒì›ìœ í˜•</th>
                            <th>ë¹„ë°€ë²ˆí˜¸</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody id="userRows">
                          <tr>
                            <td><input name="email[]" class="form-control form-control-sm" required></td>
                            <td><input name="first_name[]" class="form-control form-control-sm"></td>
                            <td>
                              <select name="user_type[]" class="form-select form-select-sm">
                                {% for val,label in USER_TYPE_CHOICES %}
                                <option value="{{ val }}">{{ label }}</option>
                                {% endfor %}
                              </select>
                            </td>
                            <td>
                              <input name="password[]" class="form-control form-control-sm"
                                    value="m123456*">
                            </td>
                            <td>
                              <button type="button"
                                      class="btn btn-sm btn-outline-danger"
                                      onclick="removeRow(this)">
                                <i class="bi bi-x"></i>
                              </button>
                            </td>
                          </tr>
                        </tbody>
                      </table>

                      <button type="button"
                              class="btn btn-sm btn-outline-primary"
                              onclick="addRow()">
                        <i class="bi bi-plus-circle"></i> í–‰ ì¶”ê°€
                      </button>

                    </div>

                    <div class="modal-footer">
                      <button class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> ì €ì¥
                      </button>
                    </div>

                  </div>
                </form>
              </div>
            </div>      


      <!-- ğŸ“‹ íšŒì› ëª©ë¡ -->
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th><i class="bi bi-person me-1"></i>ì´ë¦„</th>
              <th><i class="bi bi-envelope me-1"></i>ì•„ì´ë””(ì´ë©”ì¼)</th>
              <th><i class="bi bi-tags me-1"></i>ìœ í˜•</th>
              <th><i class="bi bi-check-circle me-1"></i>ìƒíƒœ</th>
              <th><i class="bi bi-calendar-event me-1"></i>ê°€ì…ì¼</th>
              <th class="text-center"><i class="bi bi-gear me-1"></i>ê´€ë¦¬</th>
            </tr>
          </thead>

          <tbody>
            {% for u in page_obj %}
            <tr>
              <td>{{ forloop.counter0|add:page_obj.start_index }}</td>

              <td class="fw-semibold">
                {{ u.first_name|default:u.username }}
              </td>

              <td>
                {{ u.username }}
                {% if u.email and u.email != u.username %}
                  <div class="text-muted small">{{ u.email }}</div>
                {% endif %}
              </td>

              <td>
                {% if u.profile %}
                  <span class="badge bg-info">
                    <i class="bi bi-person-lines-fill me-1"></i>{{ u.profile.user_type }}
                  </span>
                {% elif u.institution_profile %}
                  <span class="badge bg-warning text-dark">
                    <i class="bi bi-building me-1"></i>ê¸°ê´€
                  </span>
                {% else %}
                  -
                {% endif %}
              </td>

              <td>
                {% if u.is_active %}
                  <span class="badge bg-success">
                    <i class="bi bi-check-lg me-1"></i>ì™„ë£Œ
                  </span>
                {% else %}
                  <button type="button"
                          class="btn btn-sm btn-outline-secondary btn-approve"
                          data-user-id="{{ u.id }}">
                    <i class="bi bi-hourglass-split me-1"></i>ëŒ€ê¸°
                  </button>
                {% endif %}
              </td>

              <td class="text-nowrap">
                {{ u.date_joined|date:"Y-m-d H:i" }}
              </td>

              <td class="text-center">
                <div class="d-flex justify-content-center gap-1 flex-wrap">

                  {% if u.profile %}
                    {% if u.profile.user_type == 'teacher' or u.profile.user_type == 'center_teacher' %}
                      <a class="btn btn-sm btn-outline-secondary"
                         href="{% url 'teacher_career_list' u.id %}">
                        <i class="bi bi-journal-text"></i>
                      </a>
                      <a class="btn btn-sm btn-outline-secondary"
                         href="{% url 'teacher_certificate_list' u.id %}">
                        <i class="bi bi-award"></i>
                      </a>
                    {% endif %}
                  {% endif %}

                  <a class="btn btn-sm btn-outline-primary"
                     href="/admin/auth/user/{{ u.id }}/change/"
                     target="_blank">
                    <i class="bi bi-tools"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                <i class="bi bi-info-circle me-1"></i>ê²€ìƒ‰ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
      <nav class="mt-3">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?q={{ q }}&user_type={{ user_type }}&order={{ order }}&page={{ page_obj.previous_page_number }}">
                ì´ì „
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">ì´ì „</span></li>
          {% endif %}

          <li class="page-item disabled">
            <span class="page-link">
              {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
            </span>
          </li>

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?q={{ q }}&user_type={{ user_type }}&order={{ order }}&page={{ page_obj.next_page_number }}">
                ë‹¤ìŒ
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">ë‹¤ìŒ</span></li>
          {% endif %}
        </ul>
      </nav>

    </div>
  </div>
</div>

<!-- JS -->
<script>
const form = document.getElementById("filterForm");
let timer = null;

function autoSubmit() {
  form.submit();
}

/* ğŸ” ê²€ìƒ‰ debounce (filterForm ë‚´ë¶€ inputë§Œ) */
const searchInput = form.querySelector('input[name="q"]');
if (searchInput) {
  searchInput.addEventListener("input", () => {
    clearTimeout(timer);
    timer = setTimeout(autoSubmit, 400);
  });
}

/* ğŸ”¥ ì¤‘ìš”: filterForm ë‚´ë¶€ ìš”ì†Œë§Œ ìë™ submit */
form.querySelectorAll("input, select").forEach(el => {
  el.addEventListener("change", autoSubmit);
});

/* ìŠ¹ì¸ ë²„íŠ¼ */
document.querySelectorAll(".btn-approve").forEach(btn => {
  btn.addEventListener("click", () => {
    if (!confirm("í•´ë‹¹ íšŒì›ì„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½í• ê¹Œìš”?")) return;

    fetch(`/accounts/admin/activate/${btn.dataset.userId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) location.reload();
      else alert("ì²˜ë¦¬ ì‹¤íŒ¨");
    });
  });
});
</script>

<!-- ì—¬ëŸ¬ ëª… ì¶”ê°€ ëª¨ë‹¬ìš© JS (ë¶„ë¦¬ë˜ì–´ ìˆì–´ë„ OK) -->
<script>
function addRow() {
  const row = document.querySelector("#userRows tr").cloneNode(true);

  row.querySelectorAll("input").forEach(input => {
    if (input.name === "password[]") {
      input.value = "m123456*";   // âœ… ë¹„ë°€ë²ˆí˜¸ ê¸°ë³¸ê°’
    } else {
      input.value = "";           // ì´ë©”ì¼ / ì´ë¦„ë§Œ ì´ˆê¸°í™”
    }
  });

  document.getElementById("userRows").appendChild(row);
}

function removeRow(btn) {
  const tbody = document.getElementById("userRows");
  if (tbody.rows.length === 1) return;
  btn.closest("tr").remove();
}
</script>




{% endblock %}
