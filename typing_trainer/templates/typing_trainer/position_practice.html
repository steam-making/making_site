{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'typing_trainer/css/position_practice.css' %}">
{% endblock %}

{% block content %}
<div class="container py-3"
     id="typingApp"
     data-stage-id="{{ stage.id }}"
     data-lang="{{ stage.language }}"
     data-duration="{{ stage.duration_seconds }}"
     data-min-speed="{{ stage.min_speed }}"
     data-min-acc="{{ stage.min_accuracy }}"
     data-max-typo="{{ stage.max_typo }}">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <div class="text-muted small">
        {{ stage.get_stage_type_display }} · {{ stage.get_language_display }}
      </div>
      <h4 class="mb-0 fw-bold">
        <i class="bi bi-keyboard me-2"></i>{{ stage.name }}
      </h4>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" id="btnReset" type="button">
        <i class="bi bi-arrow-clockwise me-1"></i>다시
      </button>
      <a class="btn btn-outline-dark" href="{% url 'typing_trainer:home' %}">
        <i class="bi bi-list me-1"></i>목록
      </a>
    </div>
  </div>

  <div class="row g-3">
    <!-- 좌측: 연습 -->
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="small text-muted">
              남은시간:
              <span class="fw-bold" id="remainTime">{{ stage.duration_seconds }}</span>s
            </div>

            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="soundToggle" checked>
              <label class="form-check-label small" for="soundToggle">
                <i class="bi bi-volume-up me-1"></i>정답 음성
              </label>
            </div>
          </div>

          <div class="target-box mb-3">
            <div class="target-now" id="targetNow">-</div>
            <div class="target-next text-muted" id="targetNext">다음: -</div>
          </div>

          <input
            id="typingInput"
            class="form-control form-control-lg"
            placeholder="여기에 입력하세요 (시작하면 타이머가 갑니다)"
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
          />

          <div class="mt-3">
            <div class="progress">
              <div class="progress-bar" id="progressBar" style="width:0%"></div>
            </div>
          </div>

          <div class="alert alert-info mt-3 mb-0 small">
            <i class="bi bi-info-circle me-1"></i>
            정확도 <b>{{ stage.min_accuracy }}%</b>,
            타수 <b>{{ stage.min_speed }}</b>,
            오타 ≤ <b>{{ stage.max_typo }}</b> 통과!
          </div>

        </div>
      </div>

      <!-- 결과 -->
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="row g-2 text-center">
            <div class="col-6 col-md-3">
              <div class="stat-label">진행시간</div>
              <div class="stat-value" id="statDuration">0s</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-label">정확도</div>
              <div class="stat-value" id="statAcc">0%</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-label">오타수</div>
              <div class="stat-value" id="statTypo">0</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-label">타수(타/분)</div>
              <div class="stat-value" id="statSpeed">0</div>
            </div>
          </div>

          <hr>

          <button class="btn btn-success w-100" id="btnSave" disabled>
            <i class="bi bi-check2-circle me-1"></i>결과 저장
          </button>

          <div class="mt-2 text-center">
            <span class="badge bg-secondary" id="passBadge">진행중</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 우측: 키보드 -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="fw-bold mb-2">
            <i class="bi bi-grid-3x3-gap me-2"></i>키보드
          </div>

          <div id="keyboardArea"></div>

          <div class="small text-muted mt-3">
            <i class="bi bi-lightbulb me-1"></i>
            지금 눌러야 할 키가 강조 표시됩니다.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{# ✅ chars JSON 전달 (공식 권장 방식) #}
{{ chars_json|json_script:"typing-chars-data" }}

{# ✅ JS는 반드시 이 아래에서 1번만 로드 #}
<script src="{% static 'typing_trainer/js/position_practice.js' %}"></script>
{% endblock %}
